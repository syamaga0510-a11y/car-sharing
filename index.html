<!DOCTYPE html>
<html lang="ja" style="overflow-x: hidden;">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>家族カーシェア管理</title>
    <script src="https://cdn.jsdelivr.net/npm/react@18/umd/react.production.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/react-dom@18/umd/react-dom.production.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/@babel/standalone/babel.min.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-database-compat.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Outfit:wght@400;600;700&display=swap" rel="stylesheet">
    <style>
        :root {
            --primary: #2d5f8d;
            --primary-light: #4a8bc2;
            --secondary: #f39c12;
            --bg: #f8f9fc;
            --card-bg: #ffffff;
            --text: #1a1a2e;
            --text-light: #6c757d;
            --border: #e1e8ed;
            --success: #27ae60;
            --danger: #e74c3c;
            --btn-secondary-bg: #e2e8f0;
            --btn-secondary-text: #475569;
            --btn-secondary-hover: #cbd5e1;
            --shadow: 0 2px 4px rgba(0,0,0,0.1);
            --shadow-lg: 0 4px 12px rgba(0,0,0,0.15);
        }

        * { margin: 0; padding: 0; box-sizing: border-box; }
        body {
            font-family: 'Outfit', sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 20px;
            color: var(--text);
            -webkit-font-smoothing: antialiased;
            overflow-x: hidden;
        }
        
        button, input, select, textarea { font-family: 'Outfit', sans-serif; }

        .container { max-width: 1400px; margin: 0 auto; width: 100%; max-width: 100%; }
        .header {
            background: var(--card-bg); padding: 20px 30px; border-radius: 20px;
            margin-bottom: 30px; box-shadow: var(--shadow-lg);
            display: flex; justify-content: space-between; align-items: center;
            width: 100%;
            max-width: 100%;
            box-sizing: border-box;
        }
        
        .header-left { display: flex; align-items: center; gap: 20px; }
        .header h1 { 
            font-size: 2.2rem; 
            font-weight: 700; 
            color: var(--primary); 
            display: flex; 
            align-items: center; 
            gap: 10px; 
            margin: 0; 
            white-space: nowrap;
        }
        .car-icon { font-size: 2.5rem; }
        .date-display { font-family: monospace; font-size: 1.1rem; color: var(--text-light); }
        .main-content { 
            display: grid; 
            grid-template-columns: 1fr 350px; 
            gap: 30px; 
            width: 100%; 
            max-width: 100%;
            box-sizing: border-box;
        }
        
        /* Notification Styles */
        .notification-container { position: relative; margin-right: 15px; display: flex; align-items: center; }
        .notification-btn {
            background: none; border: none; font-size: 1.6rem; cursor: pointer;
            position: relative; padding: 5px; line-height: 1;
        }
        .badge {
            position: absolute; top: -2px; right: -2px;
            background: var(--danger); color: white;
            font-size: 0.7rem; font-weight: 700;
            width: 18px; height: 18px; border-radius: 50%;
            display: flex; align-items: center; justify-content: center;
            box-shadow: 0 2px 5px rgba(0,0,0,0.2);
        }

        .notification-dropdown {
            position: absolute; top: 130%; right: -50px; width: 320px;
            background: white; border-radius: 15px;
            box-shadow: 0 10px 40px rgba(0,0,0,0.2);
            z-index: 20000; padding: 15px; border: 1px solid var(--border);
            max-height: 400px;
            overflow-y: auto;
        }
        .notification-dropdown::before {
            content: ''; position: absolute; top: -8px; right: 58px;
            width: 16px; height: 16px; background: white;
            transform: rotate(45deg); border-left: 1px solid var(--border); border-top: 1px solid var(--border);
        }
        .notification-header { font-weight: 700; color: var(--primary); margin-bottom: 10px; border-bottom: 2px solid var(--bg); padding-bottom: 8px; }
        .notification-item {
            padding: 10px; border-bottom: 1px solid var(--border);
            display: flex; flex-direction: column; gap: 5px;
        }
        .notification-item:last-child { border-bottom: none; }
        .notif-title { font-weight: 600; font-size: 0.95rem; }
        .notif-desc { font-size: 0.85rem; color: var(--text-light); }
        .notif-actions { display: flex; justify-content: flex-end; margin-top: 5px; }
        
        /* Calendar Styles */
        .calendar-section { 
            background: var(--card-bg); 
            padding: 30px; 
            border-radius: 20px; 
            box-shadow: var(--shadow-lg); 
            max-width: 100%; 
            box-sizing: border-box;
        }
        .calendar-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 25px; }
        .calendar-header h2 { font-size: 1.5rem; color: var(--primary); }
        .nav-buttons { display: flex; gap: 10px; }
        .nav-btn { background: var(--primary); color: white; border: none; padding: 10px 20px; border-radius: 10px; cursor: pointer; font-weight: 600; }
        .calendar { 
            display: grid; 
            grid-template-columns: repeat(7, 1fr); 
            gap: 10px; 
            width: 100%;
            max-width: 100%;
            box-sizing: border-box;
        }
        .day-header { text-align: center; font-weight: 600; padding: 15px 5px; color: var(--primary); font-size: 0.9rem; }
        .day-header.sunday { color: #e74c3c; }
        .day-header.saturday { color: #3498db; }
        .day-cell { 
            aspect-ratio: 1; 
            border: 2px solid var(--border); 
            border-radius: 12px; 
            padding: 8px; 
            cursor: pointer; 
            position: relative; 
            background: var(--bg);
            min-height: 60px;
            min-width: 0;
            display: flex;
            flex-direction: column;
            -webkit-tap-highlight-color: transparent;
        }
        .day-cell.other-month { opacity: 0.3; }
        .day-cell.range-start { background: var(--primary); color: white; border-color: var(--primary); border-radius: 12px 0 0 12px; z-index: 1; }
        .day-cell.range-end { background: var(--primary); color: white; border-color: var(--primary); border-radius: 0 12px 12px 0; z-index: 1; }
        .day-cell.range-start.range-end { border-radius: 12px; }
        .day-cell.in-range { background: rgba(45, 95, 141, 0.15); color: var(--text); border-radius: 0; border-color: transparent; }
        .day-cell.today { background: #fff3cd; border-color: var(--secondary); font-weight: 700; }
        .day-cell.today.range-start, .day-cell.today.range-end { background: var(--primary); color: white; border-color: var(--secondary); }
        .day-cell.sunday .day-number { color: #e74c3c; }
        .day-cell.saturday .day-number { color: #3498db; }
        .day-cell.range-start .day-number, .day-cell.range-end .day-number { color: white !important; }
        .day-number { font-weight: 600; font-size: 0.95rem; margin-bottom: 5px; }
        .day-reservations { display: flex; flex-direction: column; gap: 2px; margin-top: auto; }
        .reservation-indicator { width: 100%; height: 4px; border-radius: 2px; background: var(--secondary); }

        /* Sidebar & Forms */
        .sidebar { 
            display: flex; 
            flex-direction: column; 
            gap: 20px; 
            max-width: 100%; 
            box-sizing: border-box;
        }
        .card { 
            background: var(--card-bg); 
            padding: 25px; 
            border-radius: 20px; 
            box-shadow: var(--shadow-lg); 
            max-width: 100%; 
            box-sizing: border-box;
        }
        .card h3 { font-size: 1.3rem; margin-bottom: 20px; color: var(--primary); }
        .form-group { margin-bottom: 20px; }
        .form-group label { display: block; margin-bottom: 8px; font-weight: 600; color: var(--text); font-size: 0.95rem; }
        .form-group input, .form-group select { width: 100%; padding: 12px 15px; border: 2px solid var(--border); border-radius: 10px; font-size: 1rem; }
        .form-group input:focus, .form-group select:focus { outline: none; border-color: var(--primary); }
        
        /* Buttons */
        .btn-primary { width: 100%; background: var(--primary); color: white; border: none; padding: 15px; border-radius: 12px; font-size: 1.1rem; font-weight: 600; cursor: pointer; margin-top: 10px; white-space: nowrap; }
        .btn-secondary { width: 100%; background: var(--btn-secondary-bg); color: var(--btn-secondary-text); border: none; padding: 15px; border-radius: 12px; font-size: 1.1rem; font-weight: 600; cursor: pointer; margin-top: 10px; white-space: nowrap; }

        .reservation-list { max-height: 400px; overflow-y: auto; -webkit-overflow-scrolling: touch; }
        .reservation-item { padding: 15px; background: var(--bg); border-radius: 12px; margin-bottom: 12px; border-left: 4px solid var(--secondary); }
        .reservation-item h4 { font-size: 1.05rem; margin-bottom: 8px; color: var(--primary); }
        .reservation-detail { font-size: 0.9rem; color: var(--text-light); margin-bottom: 4px; font-family: monospace; }
        .reservation-price { font-size: 1.2rem; font-weight: 700; color: var(--success); margin-top: 8px; display: flex; justify-content: space-between; align-items: center;}
        
        .delete-btn { background: var(--danger); color: white; border: none; padding: 8px 15px; border-radius: 8px; font-weight: 600; cursor: pointer; margin-top: 10px; font-size: 0.9rem; }
        
        /* Payment Status Styles */
        .payment-status { font-size: 0.8rem; padding: 4px 8px; border-radius: 6px; font-weight: 600; }
        .status-unpaid { background: #ffebee; color: #c62828; }
        .status-pending { background: #fff3e0; color: #ef6c00; }
        .status-paid { background: #e8f5e9; color: #2e7d32; }
        
        .pay-btn { background: var(--secondary); color: white; border: none; padding: 6px 12px; border-radius: 8px; font-size: 0.85rem; cursor: pointer; margin-left: 10px; }
        .confirm-btn { background: var(--success); color: white; border: none; padding: 6px 12px; border-radius: 8px; font-size: 0.85rem; cursor: pointer; margin-left: 10px; }

        /* Modals */
        .modal-overlay { position: fixed; top: 0; left: 0; right: 0; bottom: 0; background: rgba(0, 0, 0, 0.7); display: flex; align-items: center; justify-content: center; z-index: 1000; }
        .modal-content { 
            background: white; 
            padding: 30px; 
            border-radius: 20px; 
            box-shadow: 0 20px 60px rgba(0,0,0,0.3); 
            max-width: 450px; 
            width: 90%; 
            max-height: 85vh; 
            overflow-y: auto; 
            display: flex; 
            flex-direction: column;
            -webkit-overflow-scrolling: touch;
        }
        
        .modal-content h2 { color: var(--primary); margin-bottom: 20px; text-align: center; font-size: 1.6rem; flex-shrink: 0; }
        
        /* Modal specific scrollable areas */
        .member-list { display: flex; flex-direction: column; gap: 10px; overflow-y: auto; margin-bottom: 20px; flex: 1; padding-right: 5px; -webkit-overflow-scrolling: touch; }
        .member-item { display: flex; justify-content: space-between; align-items: center; padding: 12px; background: var(--bg); border-radius: 8px; border: 2px solid var(--border); flex-shrink: 0; }
        .member-name { font-weight: 600; color: var(--text); }
        
        /* Buttons in Header */
        .header-btn { border: none; padding: 8px 16px; border-radius: 8px; cursor: pointer; font-weight: 600; font-size: 0.9rem; margin-left: 5px; }
        .logout-btn { background: var(--danger); color: white; }
        .manage-members-btn { background: var(--primary); color: white; }
        .add-member-btn { background: var(--success); color: white; }
        .admin-mode-btn { background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white; }
        .my-history-btn { background: var(--secondary); color: white; }

        /* Small action buttons in lists */
        .list-action-btn { border: none; padding: 6px 12px; border-radius: 6px; cursor: pointer; font-size: 0.85rem; font-weight: 600; margin-left: 5px; white-space: nowrap; }
        .btn-promote { background: var(--secondary); color: white; }
        .btn-demote { background: var(--text-light); color: white; }
        .btn-delete { background: var(--danger); color: white; }

        /* Stats Table - 改善版 */
        .stats-table { 
            width: 100%; 
            border-collapse: collapse; 
            margin-top: 10px;
            font-size: 0.9rem;
        }
        .stats-table th, .stats-table td { 
            padding: 8px 10px;
            text-align: left; 
            border-bottom: 1px solid var(--border); 
        }
        .stats-table th { 
            background: var(--primary);
            color: white;
            font-weight: 600;
            position: sticky;
            top: 0;
            z-index: 10;
        }
        .stats-table tbody tr:hover {
            background: var(--bg);
        }
        .stats-table tfoot td { 
            font-weight: 700; 
            background: #fff3cd; 
            border-top: 2px solid var(--secondary);
            padding: 10px;
        }

        .month-selector { 
            display: flex; 
            align-items: center; 
            gap: 10px; 
            margin-bottom: 15px;
            justify-content: center; 
            flex-shrink: 0; 
        }
        .month-selector button { 
            padding: 6px 12px;
            background: var(--primary); 
            color: white; 
            border: none; 
            border-radius: 8px; 
            cursor: pointer; 
            font-weight: 600;
            font-size: 0.9rem;
        }
        .month-selector span {
            font-size: 1.1rem;
            font-weight: 600;
            min-width: 140px;
            text-align: center;
        }
        
        /* Admin Mode Tabs - 改善版 */
        .admin-tabs { 
            display: flex; 
            gap: 8px; 
            margin-bottom: 15px;
            justify-content: center; 
        }
        .admin-tab { 
            padding: 8px 16px;
            border: 2px solid transparent; 
            border-radius: 12px;
            background: var(--bg); 
            cursor: pointer; 
            font-weight: 600; 
            color: var(--text-light);
            font-size: 0.9rem;
            transition: all 0.2s;
        }
        .admin-tab.active { 
            background: var(--primary); 
            color: white; 
            box-shadow: var(--shadow);
        }

        /* 管理者モーダル専用スタイル - 改善版 */
        .admin-modal-content {
            max-width: 95vw !important;
            width: 1100px !important;
            max-height: 90vh !important;
            padding: 20px !important;
        }
        .admin-modal-content h2 {
            font-size: 1.4rem !important;
            margin-bottom: 15px !important;
        }
        .admin-stats-section {
            flex: 1;
            overflow-y: auto;
            min-height: 0;
        }
        .admin-stats-section h3 {
            color: var(--primary);
            margin-top: 5px;
            margin-bottom: 8px;
            font-size: 1.1rem;
        }
        .admin-detail-section {
            margin-top: 20px;
            border-top: 2px solid var(--border);
            padding-top: 15px;
        }
        .admin-detail-section h3 {
            font-size: 1.05rem;
        }
        .admin-reservation-list {
            max-height: 280px;
            overflow-y: auto;
        }
        .admin-reservation-item {
            padding: 10px;
            background: var(--bg);
            border-radius: 8px;
            margin-bottom: 8px;
            border-left: 3px solid var(--secondary);
        }
        .admin-reservation-item h4 {
            font-size: 0.95rem;
            margin-bottom: 5px;
            color: var(--primary);
        }
        .admin-reservation-detail {
            font-size: 0.8rem;
            color: var(--text-light);
            margin-bottom: 3px;
        }
        .admin-reservation-price {
            font-size: 1rem;
            font-weight: 700;
            color: var(--success);
            margin-top: 5px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            flex-wrap: wrap;
            gap: 5px;
        }

        /* Settings Form */
        .settings-list {
            display: flex;
            flex-direction: column;
            gap: 12px;
        }
        .setting-item {
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 12px;
            background: var(--bg);
            border-radius: 10px;
            border: 2px solid var(--border);
        }
        .setting-label {
            font-weight: 600;
            color: var(--text);
            font-size: 0.9rem;
        }
        .setting-input-group {
            display: flex;
            align-items: center;
            gap: 8px;
        }
        .setting-input {
            width: 90px;
            padding: 6px;
            border-radius: 8px;
            border: 2px solid var(--border);
            text-align: right;
            font-size: 0.95rem;
        }

        /* Forms */
        .login-form { display: flex; flex-direction: column; gap: 15px; }
        .pin-input { padding: 15px; font-size: 1.5rem; text-align: center; border: 2px solid var(--border); border-radius: 10px; font-family: monospace; letter-spacing: 0.5em; }
        .pin-input:focus { outline: none; border-color: var(--primary); }
        
        /* Checkbox styling */
        .checkbox-container {
            display: flex;
            align-items: center;
            gap: 12px;
            padding: 12px;
            border: 2px solid var(--border);
            border-radius: 10px;
            cursor: pointer;
            background: var(--bg);
        }
        .checkbox-input { width: 20px; height: 20px; accent-color: var(--primary); cursor: pointer; margin: 0; }
        .checkbox-text { font-weight: 600; color: var(--text); user-select: none; }

        .calculation-display { background: #fff3cd; padding: 15px; border-radius: 10px; margin-top: 15px; border-left: 4px solid var(--secondary); }
        .calculation-display p { margin: 5px 0; font-size: 0.95rem; }
        
        /* Toast Message */
        .toast {
            position: fixed;
            top: 20px;
            left: 50%;
            transform: translateX(-50%);
            background: var(--primary);
            color: white;
            padding: 15px 30px;
            border-radius: 12px;
            box-shadow: 0 4px 12px rgba(0,0,0,0.3);
            z-index: 10000;
            font-weight: 600;
            font-size: 1rem;
            animation: slideDown 0.3s ease-out;
            max-width: 90%;
            text-align: center;
        }
        .toast.success { background: var(--success); }
        .toast.error { background: var(--danger); }
        
        @keyframes slideDown {
            from {
                opacity: 0;
                transform: translateX(-50%) translateY(-20px);
            }
            to {
                opacity: 1;
                transform: translateX(-50%) translateY(0);
            }
        }
        
        /* ===== スマホ対応の強化 ===== */
        @media (max-width: 768px) {
            body { padding: 10px; }
            
            .container { padding: 0; }
            
            .header { 
                flex-direction: column; 
                gap: 15px; 
                padding: 15px; 
            }
            .header-left { 
                flex-direction: column; 
                text-align: center;
                width: 100%;
            }
            .header h1 { 
                font-size: 1.5rem;
                flex-direction: column;
                gap: 5px;
            }
            .car-icon { font-size: 2rem; }
            .date-display { font-size: 0.85rem; }
            
            .notification-container {
                position: relative;
                margin-right: 0;
            }
            .notification-dropdown {
                position: fixed;
                top: 50%;
                left: 50%;
                right: auto;
                transform: translate(-50%, -50%);
                width: calc(100vw - 40px);
                max-width: 350px;
                max-height: 70vh;
                overflow-y: auto;
                z-index: 10000;
            }
            .notification-dropdown::before {
                display: none;
            }
            
            .header-btn { 
                font-size: 0.75rem;
                padding: 6px 10px;
                margin: 3px;
            }
            
            .main-content { 
                grid-template-columns: 1fr;
                gap: 15px;
            }
            
            .calendar-section { 
                padding: 15px; 
            }
            .calendar-header { 
                flex-direction: column;
                gap: 10px;
                margin-bottom: 15px;
            }
            .calendar-header h2 { 
                font-size: 1.2rem; 
            }
            .nav-buttons { 
                width: 100%;
                justify-content: center;
            }
            .nav-btn { 
                padding: 8px 20px;
                font-size: 0.9rem;
            }
            
            .calendar { 
                gap: 4px;
            }
            .day-header { 
                padding: 8px 2px;
                font-size: 0.75rem;
            }
            .day-cell { 
                padding: 4px;
                border-radius: 8px;
                min-height: 50px;
                border-width: 1px;
            }
            .day-number { 
                font-size: 0.8rem;
                margin-bottom: 2px;
            }
            .day-reservations { 
                gap: 1px; 
            }
            .reservation-indicator { 
                height: 3px;
            }
            
            .card { 
                padding: 15px; 
            }
            .card h3 { 
                font-size: 1.1rem;
                margin-bottom: 15px;
            }
            
            .form-group { 
                margin-bottom: 15px; 
            }
            .form-group label { 
                font-size: 0.85rem; 
            }
            .form-group input, 
            .form-group select { 
                padding: 10px;
                font-size: 0.9rem;
            }
            
            .reservation-list { 
                max-height: 300px; 
            }
            .reservation-item { 
                padding: 12px; 
            }
            .reservation-item h4 { 
                font-size: 0.95rem; 
            }
            .reservation-detail { 
                font-size: 0.8rem; 
            }
            .reservation-price { 
                font-size: 1rem;
                flex-direction: column;
                align-items: flex-start;
                gap: 8px;
            }
            
            .btn-primary, 
            .btn-secondary { 
                padding: 12px;
                font-size: 1rem;
            }
            .delete-btn,
            .pay-btn,
            .confirm-btn { 
                font-size: 0.75rem;
                padding: 5px 10px;
            }
            
            .modal-content { 
                padding: 20px;
                width: 95%;
                max-height: 90vh;
            }
            .modal-content h2 { 
                font-size: 1.3rem;
                margin-bottom: 10px;
            }
            
            /* 管理者モーダルのスマホ対応 */
            .admin-modal-content {
                width: 95% !important;
                padding: 15px !important;
            }
            .admin-modal-content h2 {
                font-size: 1.2rem !important;
            }
            .stats-table {
                font-size: 0.75rem;
            }
            .stats-table th,
            .stats-table td {
                padding: 6px 4px;
            }
            
            .member-item { 
                padding: 10px;
                flex-direction: column;
                gap: 8px;
                align-items: flex-start;
            }
            .list-action-btn { 
                font-size: 0.75rem;
                padding: 5px 10px;
            }
            
            .month-selector { 
                gap: 8px; 
            }
            .month-selector button { 
                padding: 6px 12px;
                font-size: 0.9rem;
            }
            .month-selector span { 
                font-size: 1rem !important;
                min-width: 120px !important;
            }
            
            .admin-tabs { 
                gap: 8px;
                flex-wrap: wrap;
            }
            .admin-tab { 
                padding: 8px 15px;
                font-size: 0.85rem;
            }
            
            .setting-item { 
                padding: 12px;
                flex-direction: column;
                align-items: flex-start;
                gap: 8px;
            }
            .setting-label { 
                font-size: 0.9rem; 
            }
            .setting-input { 
                width: 80px;
                padding: 6px;
                font-size: 0.9rem;
            }
            
            .calculation-display { 
                padding: 12px; 
            }
            .calculation-display p { 
                font-size: 0.85rem; 
            }
        }
        
        @media (max-width: 360px) {
            .calendar { 
                gap: 2px; 
            }
            .day-cell { 
                padding: 2px;
                min-height: 45px;
            }
            .day-number { 
                font-size: 0.7rem; 
            }
            .day-header { 
                font-size: 0.65rem;
                padding: 6px 1px;
            }
        }

        /* デスクトップのみのホバー効果 */
        @media (hover: hover) and (pointer: fine) {
            .notification-btn:hover { transform: scale(1.1); }
            .nav-btn:hover { background: var(--primary-light); transform: translateY(-2px); box-shadow: var(--shadow); }
            .day-cell:hover { border-color: var(--primary); transform: scale(1.05); box-shadow: var(--shadow); z-index: 2; }
            .btn-primary:hover { transform: translateY(-2px); box-shadow: var(--shadow-lg); }
            .btn-secondary:hover { background: var(--btn-secondary-hover); transform: translateY(-2px); }
            .delete-btn:hover { background: #c0392b; transform: scale(1.05); }
            .pay-btn:hover { background: #e67e22; }
            .confirm-btn:hover { background: #219150; }
            .checkbox-container:hover { border-color: var(--primary); }
            .stats-table tbody tr:hover { background: var(--bg); }
            .logout-btn:hover { background: #c0392b; transform: translateY(-2px); }
            .manage-members-btn:hover { background: var(--primary-light); transform: translateY(-2px); }
            .add-member-btn:hover { background: #219150; transform: translateY(-2px); }
            .admin-mode-btn:hover { transform: translateY(-2px); box-shadow: 0 4px 12px rgba(102, 126, 234, 0.4); }
            .my-history-btn:hover { background: #e67e22; transform: translateY(-2px); }
            .month-selector button:hover { background: var(--primary-light); }
            .admin-tab:hover:not(.active) { background: var(--border); }
        }
    </style>
</head>
<body>
    <div id="root"></div>

    <script type="text/babel">
        const { useState, useEffect, useRef, useMemo, useCallback } = React;

        const INITIAL_MEMBERS = [
            { name: '管理者', pin: '0000', isAdmin: true }
        ];

        const DEFAULT_PRICE_SETTINGS = {
            rates: [
                { hours: 1, price: 500 },
                { hours: 3, price: 1000 },
                { hours: 6, price: 2000 },
                { hours: 12, price: 2500 },
                { hours: 24, price: 3000 },
                { hours: 48, price: 6000 }
            ],
            extraDayPrice: 3000
        };

        const firebaseConfig = {
          apiKey: "AIzaSyCd8tnYHwCY93tEXRhxPIjX9Dks2ly25MY",
          authDomain: "family-car-share-8a1c4.firebaseapp.com",
          databaseURL: "https://family-car-share-8a1c4-default-rtdb.asia-southeast1.firebasedatabase.app",
          projectId: "family-car-share-8a1c4",
          storageBucket: "family-car-share-8a1c4.firebasestorage.app",
          messagingSenderId: "61412197996",
          appId: "1:61412197996:web:d65b24df6a1bb83519ba49",
          measurementId: "G-C0CP5Z1ZND"
        };


        let database;
        let isFirebaseReady = false;
        try {
            if (!firebase.apps.length) {
                firebase.initializeApp(firebaseConfig);
            }
            database = firebase.database();
            isFirebaseReady = true;
        } catch (error) {
            console.error('Firebase初期化エラー:', error);
        }

        const CarSharingApp = () => {
            const [currentDate, setCurrentDate] = useState(new Date());
            const [rangeStart, setRangeStart] = useState(new Date());
            const [rangeEnd, setRangeEnd] = useState(new Date());
            const [reservations, setReservations] = useState([]);
            const [formData, setFormData] = useState(() => {
                const today = new Date();
                const year = today.getFullYear();
                const month = String(today.getMonth() + 1).padStart(2, '0');
                const day = String(today.getDate()).padStart(2, '0');
                const localDateString = `${year}-${month}-${day}`;
                return {
                    member: '',
                    startDate: localDateString,
                    startHour: '12', startMinute: '00',
                    endDate: localDateString,
                    endHour: '12', endMinute: '00'
                };
            });
            const [calculatedPrice, setCalculatedPrice] = useState(null);
            const [calculatedHours, setCalculatedHours] = useState(null);
            const [isLoading, setIsLoading] = useState(true);
            const [connectionStatus, setConnectionStatus] = useState('接続中...');
            
            const [currentUser, setCurrentUser] = useState(null);
            const [isAuthenticated, setIsAuthenticated] = useState(false);
            const [showLoginModal, setShowLoginModal] = useState(true);
            const [pinInput, setPinInput] = useState('');
            const [selectedMemberForLogin, setSelectedMemberForLogin] = useState('');
            const [members, setMembers] = useState([]);
            const [isAdmin, setIsAdmin] = useState(false);
            
            const [toastMessage, setToastMessage] = useState('');
            const [toastType, setToastType] = useState('success');
            const [showToast, setShowToast] = useState(false);

            const [showMemberListModal, setShowMemberListModal] = useState(false);
            const [showAddMemberModal, setShowAddMemberModal] = useState(false);
            const [showAdminMode, setShowAdminMode] = useState(false);
            const [showMyHistoryModal, setShowMyHistoryModal] = useState(false);
            const [showNotifications, setShowNotifications] = useState(false);
            const [showSwitchUserModal, setShowSwitchUserModal] = useState(false);
            const [switchToMember, setSwitchToMember] = useState('');

            const notificationRef = useRef(null);

            const [newMemberName, setNewMemberName] = useState('');
            const [newMemberPin, setNewMemberPin] = useState('');
            const [newMemberIsAdmin, setNewMemberIsAdmin] = useState(false);

            const [selectedMonth, setSelectedMonth] = useState(new Date());
            const [selectedMemberForStats, setSelectedMemberForStats] = useState('');
            const [adminTab, setAdminTab] = useState('stats');
            
            const [priceSettings, setPriceSettings] = useState(DEFAULT_PRICE_SETTINGS);
            
            const [myHistoryMonth, setMyHistoryMonth] = useState(new Date());

            useEffect(() => {
                const savedUser = localStorage.getItem('authenticatedUser');
                if (savedUser) {
                    setCurrentUser(savedUser);
                    setIsAuthenticated(true);
                    setShowLoginModal(false);
                }
            }, []);

            useEffect(() => {
                const handleClickOutside = (event) => {
                    if (notificationRef.current && !notificationRef.current.contains(event.target)) {
                        setShowNotifications(false);
                    }
                };
                document.addEventListener('mousedown', handleClickOutside);
                return () => {
                    document.removeEventListener('mousedown', handleClickOutside);
                };
            }, []);

            useEffect(() => {
                if (currentUser && members.length > 0) {
                    const member = members.find(m => m.name === currentUser);
                    if (member) setIsAdmin(member.isAdmin || false);
                }
            }, [members, currentUser]);

            useEffect(() => {
                if (!isFirebaseReady) {
                    setConnectionStatus('Firebase設定が必要です');
                    setIsLoading(false);
                    return;
                }

                const membersRef = database.ref('members');
                membersRef.on('value', (snapshot) => {
                    const data = snapshot.val();
                    if (data) {
                        const membersList = Object.keys(data).map(key => ({
                            id: key,
                            name: data[key].name,
                            pin: data[key].pin,
                            isAdmin: data[key].isAdmin || false
                        }));
                        setMembers(membersList);
                        if (membersList.length > 0 && !selectedMemberForLogin) {
                            setSelectedMemberForLogin(membersList[0].name);
                        }
                    } else {
                        INITIAL_MEMBERS.forEach(member => {
                            membersRef.push({ name: member.name, pin: member.pin, isAdmin: member.isAdmin || false });
                        });
                    }
                });

                const reservationsRef = database.ref('reservations');
                reservationsRef.on('value', (snapshot) => {
                    const data = snapshot.val();
                    if (data) {
                        const reservationsList = Object.keys(data).map(key => ({
                            ...data[key],
                            id: key,
                            paymentStatus: data[key].paymentStatus || 'unpaid' 
                        }));
                        setReservations(reservationsList);
                    } else {
                        setReservations([]);
                    }
                    setIsLoading(false);
                });

                const settingsRef = database.ref('settings/prices');
                settingsRef.on('value', (snapshot) => {
                    const data = snapshot.val();
                    if (data) {
                        setPriceSettings(data);
                    }
                });
                
                const connectedRef = database.ref('.info/connected');
                connectedRef.on('value', (s) => setConnectionStatus(s.val() ? '✅ 同期中' : '⚠️ オフライン'));
                
                return () => { 
                    membersRef.off(); 
                    reservationsRef.off();
                    settingsRef.off();
                    connectedRef.off(); 
                };
            }, []);

            const calculatePrice = useCallback((hours, settings) => {
                const { rates, extraDayPrice } = settings;
                
                for (const rate of rates) {
                    if (hours <= rate.hours) {
                        return rate.price;
                    }
                }
                
                const maxRate = rates[rates.length - 1];
                const extraHours = hours - maxRate.hours;
                const extraDays = Math.ceil(extraHours / 24);
                return maxRate.price + (extraDays * extraDayPrice);
            }, []);

            useEffect(() => {
                if (formData.startDate && formData.startHour !== '' && formData.startMinute !== '' && 
                    formData.endDate && formData.endHour !== '' && formData.endMinute !== '') {
                    const startDateTime = new Date(`${formData.startDate}T${formData.startHour}:${formData.startMinute}:00`);
                    const endDateTime = new Date(`${formData.endDate}T${formData.endHour}:${formData.endMinute}:00`);
                    if (endDateTime > startDateTime) {
                        const diffHours = (endDateTime - startDateTime) / (1000 * 60 * 60);
                        setCalculatedHours(diffHours);
                        setCalculatedPrice(calculatePrice(diffHours, priceSettings));
                    } else {
                        setCalculatedPrice(null); setCalculatedHours(null);
                    }
                } else {
                    setCalculatedPrice(null); setCalculatedHours(null);
                }
            }, [formData, priceSettings, calculatePrice]);
            
            const showToastMessage = useCallback((message, type = 'success') => {
                setToastMessage(message);
                setToastType(type);
                setShowToast(true);
                setTimeout(() => {
                    setShowToast(false);
                }, 3000);
            }, []);

            useEffect(() => {
                if (!rangeStart) return;
                const formatDate = (date) => {
                    const year = date.getFullYear();
                    const month = String(date.getMonth() + 1).padStart(2, '0');
                    const day = String(date.getDate()).padStart(2, '0');
                    return `${year}-${month}-${day}`;
                };
                const startStr = formatDate(rangeStart);
                const endStr = rangeEnd ? formatDate(rangeEnd) : startStr;
                setFormData(prev => ({ ...prev, startDate: startStr, endDate: endStr }));
            }, [rangeStart, rangeEnd]);

            useEffect(() => {
                if (currentUser) setFormData(prev => ({ ...prev, member: currentUser }));
            }, [currentUser]);

            const handleDateClick = useCallback((date) => {
                setRangeStart(prevStart => {
                    setRangeEnd(prevEnd => {
                        if ((!prevStart && !prevEnd) || (prevStart && prevEnd)) {
                            return null;
                        } else if (prevStart && !prevEnd) {
                            if (date < prevStart) return null;
                            else return date;
                        }
                        return prevEnd;
                    });
                    
                    if ((!prevStart && !rangeEnd) || (prevStart && rangeEnd)) {
                        return date;
                    } else if (prevStart && !rangeEnd) {
                        if (date < prevStart) return date;
                        else return prevStart;
                    }
                    return prevStart;
                });
            }, [rangeEnd]);

            const handleLogin = useCallback((e) => {
                e.preventDefault();
                const member = members.find(m => m.name === selectedMemberForLogin);
                if (member && member.pin === pinInput) {
                    setCurrentUser(selectedMemberForLogin);
                    setIsAuthenticated(true);
                    setIsAdmin(member.isAdmin || false);
                    setShowLoginModal(false);
                    localStorage.setItem('authenticatedUser', selectedMemberForLogin);
                    setPinInput('');
                    showToastMessage(`${selectedMemberForLogin}としてログインしました`, 'success');
                } else {
                    showToastMessage('PINコードが正しくありません', 'error');
                    setPinInput('');
                }
            }, [members, selectedMemberForLogin, pinInput, showToastMessage]);

            const handleLogout = useCallback(() => {
                if (window.confirm('ログアウトしますか？')) {
                    setCurrentUser(null); setIsAuthenticated(false); setIsAdmin(false);
                    setShowLoginModal(true); setShowAdminMode(false); setShowMyHistoryModal(false);
                    localStorage.removeItem('authenticatedUser'); setPinInput('');
                }
            }, []);

            const handleSwitchUser = useCallback((memberName) => {
                setSwitchToMember(memberName);
                setShowSwitchUserModal(true);
                setShowMemberListModal(false);
                setPinInput('');
            }, []);

            const handleConfirmSwitchUser = useCallback((e) => {
                e.preventDefault();
                const member = members.find(m => m.name === switchToMember);
                if (member && member.pin === pinInput) {
                    setCurrentUser(switchToMember);
                    setIsAdmin(member.isAdmin || false);
                    setShowSwitchUserModal(false);
                    localStorage.setItem('authenticatedUser', switchToMember);
                    setPinInput('');
                    const userName = switchToMember;
                    setSwitchToMember('');
                    showToastMessage(`${userName}に切り替えました`, 'success');
                } else {
                    showToastMessage('PINコードが正しくありません', 'error');
                    setPinInput('');
                }
            }, [members, switchToMember, pinInput, showToastMessage]);

            const updatePaymentStatus = useCallback(async (id, status) => {
                try {
                    await database.ref(`reservations/${id}`).update({ paymentStatus: status });
                } catch (e) {
                    console.error('支払い状況更新エラー', e);
                    alert('更新に失敗しました');
                }
            }, []);

            const handleSaveSettings = useCallback(async () => {
                if (!isAdmin) return;
                try {
                    await database.ref('settings/prices').set(priceSettings);
                    alert('料金設定を保存しました');
                } catch (e) {
                    console.error('設定保存エラー', e);
                    alert('設定の保存に失敗しました');
                }
            }, [isAdmin, priceSettings]);

            const handleSettingChange = useCallback((index, field, value) => {
                setPriceSettings(prev => {
                    const newRates = [...prev.rates];
                    newRates[index][field] = Number(value);
                    return { ...prev, rates: newRates };
                });
            }, []);

            const handleAddMember = useCallback(async (e) => {
                e.preventDefault();
                if (!newMemberName || !newMemberPin) return alert('入力が不足しています');
                if (!/^\d{4}$/.test(newMemberPin)) return alert('PINは4桁の数字で');
                if (members.some(m => m.name === newMemberName)) return alert('同名のメンバーが存在します');
                try {
                    await database.ref('members').push({ name: newMemberName, pin: newMemberPin, isAdmin: newMemberIsAdmin });
                    setNewMemberName(''); setNewMemberPin(''); setNewMemberIsAdmin(false);
                    setShowAddMemberModal(false);
                    alert('メンバーを追加しました');
                } catch (e) { alert('追加失敗'); }
            }, [newMemberName, newMemberPin, newMemberIsAdmin, members]);

            const handleDeleteMember = useCallback(async (id, name) => {
                if (!isAdmin) return;
                const m = members.find(m => m.id === id);
                if (m && m.isAdmin) return alert('管理者は削除できません');
                if (reservations.some(r => r.member === name)) return alert('予約があるため削除できません');
                if (window.confirm(`${name}を削除しますか？`)) {
                    await database.ref(`members/${id}`).remove();
                }
            }, [isAdmin, members, reservations]);

            const handleToggleAdmin = useCallback(async (id, name, makeAdmin) => {
                if (!isAdmin) return;
                if (window.confirm(`${name}の権限を変更しますか？`)) {
                    const m = members.find(m => m.id === id);
                    await database.ref(`members/${id}`).update({ ...m, isAdmin: makeAdmin });
                }
            }, [isAdmin, members]);

            const handleSubmit = useCallback(async (e) => {
                e.preventDefault();
                if (!formData.startDate || !formData.endDate || !calculatedPrice) return alert('日時を確認してください');
                if (!isFirebaseReady) return alert('Firebase設定が必要です');

                const startDateTime = `${formData.startDate} ${formData.startHour}:${formData.startMinute}`;
                const endDateTime = `${formData.endDate} ${formData.endHour}:${formData.endMinute}`;
                const newStart = new Date(`${formData.startDate}T${formData.startHour}:${formData.startMinute}:00`);
                const newEnd = new Date(`${formData.endDate}T${formData.endHour}:${formData.endMinute}:00`);

                const hasConflict = reservations.some(reservation => {
                    let rStart, rEnd;
                    if (reservation.startDateTime && reservation.endDateTime) {
                        rStart = new Date(reservation.startDateTime.replace(' ', 'T'));
                        rEnd = new Date(reservation.endDateTime.replace(' ', 'T'));
                    } else { 
                        rStart = new Date(`${reservation.date}T${reservation.startTime}:00`);
                        rEnd = new Date(`${reservation.date}T${reservation.endTime}:00`);
                    }
                    return newStart < rEnd && newEnd > rStart;
                });

                if (hasConflict) return alert('予約が重複しています');

                const newReservation = {
                    member: formData.member,
                    startDateTime, endDateTime, startDate: formData.startDate,
                    hours: calculatedHours, price: calculatedPrice,
                    createdAt: firebase.database.ServerValue.TIMESTAMP,
                    paymentStatus: 'unpaid'
                };

                try {
                    await database.ref('reservations').push(newReservation);
                    setFormData(prev => ({ ...prev, startDate: formData.startDate, endDate: formData.startDate }));
                    alert('予約しました');
                } catch (e) { alert('予約失敗'); }
            }, [formData, calculatedPrice, calculatedHours, reservations]);

            const handleDeleteReservation = useCallback(async (id) => {
                if (window.confirm('予約を削除しますか？')) await database.ref(`reservations/${id}`).remove();
            }, []);

            const days = useMemo(() => {
                const year = currentDate.getFullYear(), month = currentDate.getMonth();
                const daysInMonth = new Date(year, month + 1, 0).getDate();
                const firstDay = new Date(year, month, 1).getDay();
                const prevLast = new Date(year, month, 0).getDate();
                const days = [];
                for (let i = firstDay - 1; i >= 0; i--) days.push({ date: new Date(year, month - 1, prevLast - i), isCurrentMonth: false });
                for (let i = 1; i <= daysInMonth; i++) days.push({ date: new Date(year, month, i), isCurrentMonth: true });
                const remaining = 42 - days.length;
                for (let i = 1; i <= remaining; i++) days.push({ date: new Date(year, month + 1, i), isCurrentMonth: false });
                return days;
            }, [currentDate]);

            const getReservationsForDate = useCallback((date) => {
                const dayStart = new Date(date); dayStart.setHours(0,0,0,0);
                const dayEnd = new Date(date); dayEnd.setHours(23,59,59,999);
                return reservations.filter(r => {
                    let s, e;
                    if (r.startDateTime) { s = new Date(r.startDateTime.replace(' ', 'T')); e = new Date(r.endDateTime.replace(' ', 'T')); }
                    else { s = new Date(`${r.date}T${r.startTime}:00`); e = new Date(`${r.date}T${r.endTime}:00`); }
                    return s < dayEnd && e > dayStart;
                });
            }, [reservations]);

            const getReservationsForMonth = useCallback((member, year, month) => {
                return reservations.filter(r => {
                    const d = new Date((r.startDate || r.date) + 'T00:00:00');
                    return (member === 'ALL' || r.member === member) && d.getFullYear() === year && d.getMonth() === month;
                }).sort((a, b) => new Date((a.startDate||a.date)+'T00:00:00') - new Date((b.startDate||b.date)+'T00:00:00'));
            }, [reservations]);

            const getMemberStatsForMonth = useCallback((year, month) => {
                const stats = {};
                let totalAllCount = 0, totalAllHours = 0, totalAllPrice = 0;

                reservations.forEach(r => {
                    const d = new Date((r.startDate || r.date) + 'T00:00:00');
                    if (d.getFullYear() === year && d.getMonth() === month) {
                        if (!stats[r.member]) stats[r.member] = { count: 0, totalHours: 0, totalPrice: 0 };
                        stats[r.member].count++;
                        stats[r.member].totalHours += r.hours;
                        stats[r.member].totalPrice += r.price;
                        
                        totalAllCount++;
                        totalAllHours += r.hours;
                        totalAllPrice += r.price;
                    }
                });
                return { stats, totalAllCount, totalAllHours, totalAllPrice };
            }, [reservations]);

            const renderStatusBadge = useCallback((status) => {
                if (status === 'confirmed') return <span className="payment-status status-paid">受取済</span>;
                if (status === 'pending') return <span className="payment-status status-pending">確認待ち</span>;
                return <span className="payment-status status-unpaid">未払い</span>;
            }, []);

            const notifications = useMemo(() => {
                const now = new Date();
                const isPast = (r) => {
                    let end;
                    if (r.endDateTime) end = new Date(r.endDateTime.replace(' ', 'T'));
                    else end = new Date(`${r.date}T${r.endTime}:00`);
                    return end < now;
                };

                if (isAdmin) {
                    return reservations.filter(r => r.paymentStatus === 'pending');
                } else {
                    return reservations.filter(r => r.member === currentUser && r.paymentStatus === 'unpaid' && isPast(r));
                }
            }, [isAdmin, reservations, currentUser]);

            if (isLoading) return <div className="container" style={{textAlign:'center', padding:'50px'}}>データを読み込み中...</div>;

            const sidebarDate = rangeStart || new Date();
            const selectedDateReservations = getReservationsForDate(sidebarDate);

            return (
                <>
                    {showToast && (
                        <div className={`toast ${toastType}`}>
                            {toastMessage}
                        </div>
                    )}
                    
                    {showLoginModal && (
                        <div className="modal-overlay">
                            <div className="modal-content">
                                <h2>🔐 ログイン</h2>
                                
                                {!isFirebaseReady && (
                                    <div style={{padding: '20px', textAlign: 'center'}}>
                                        <p style={{color: 'var(--danger)', marginBottom: '15px', fontWeight: '600'}}>
                                            ⚠️ Firebase接続エラー
                                        </p>
                                        <p style={{fontSize: '0.9rem', color: 'var(--text-light)', lineHeight: '1.6'}}>
                                            Firebase設定を確認してください。<br/>
                                            コード内の firebaseConfig を<br/>
                                            正しい設定に置き換える必要があります。
                                        </p>
                                    </div>
                                )}
                                
                                {isFirebaseReady && isLoading && (
                                    <div style={{padding: '20px', textAlign: 'center'}}>
                                        <p style={{color: 'var(--text-light)'}}>メンバー情報を読み込み中...</p>
                                    </div>
                                )}
                                
                                {isFirebaseReady && !isLoading && members.length === 0 && (
                                    <div style={{padding: '20px', textAlign: 'center'}}>
                                        <p style={{color: 'var(--danger)', marginBottom: '10px'}}>メンバーが登録されていません</p>
                                        <p style={{fontSize: '0.85rem', color: 'var(--text-light)'}}>
                                            Firebaseデータベースにメンバーを追加してください
                                        </p>
                                    </div>
                                )}
                                
                                {isFirebaseReady && !isLoading && members.length > 0 && (
                                    <form onSubmit={handleLogin} className="login-form">
                                        <div className="form-group">
                                            <label>使用者を選択</label>
                                            <select value={selectedMemberForLogin} onChange={(e) => setSelectedMemberForLogin(e.target.value)}>
                                                {members.map(m => <option key={m.id} value={m.name}>{m.name}</option>)}
                                            </select>
                                        </div>
                                        <input type="password" inputMode="numeric" pattern="[0-9]*" className="pin-input" value={pinInput} onChange={e => setPinInput(e.target.value)} maxLength="4" placeholder="••••" required autoFocus />
                                        <button type="submit" className="btn-primary">ログイン</button>
                                    </form>
                                )}
                            </div>
                        </div>
                    )}

                    {showMemberListModal && (
                        <div className="modal-overlay" onClick={() => setShowMemberListModal(false)}>
                            <div className="modal-content" style={{maxWidth: '500px'}} onClick={(e) => e.stopPropagation()}>
                                <h2>👥 メンバー一覧</h2>
                                <div className="member-list">
                                    {members.map(m => (
                                        <div key={m.id} className="member-item">
                                            <div style={{flex: 1, overflow: 'hidden', textOverflow: 'ellipsis', whiteSpace: 'nowrap'}}>
                                                <span className="member-name">{m.name}</span> {m.isAdmin && '👑'}
                                                {m.name === currentUser && <span style={{marginLeft: '8px', fontSize: '0.85rem', color: 'var(--success)'}}>（ログイン中）</span>}
                                            </div>
                                            <div style={{display: 'flex', gap: '5px', flexWrap: 'wrap'}}>
                                                {m.name !== currentUser && (
                                                    <button className="list-action-btn btn-switch" onClick={() => handleSwitchUser(m.name)} style={{background: 'var(--primary)', color: 'white'}}>ログイン</button>
                                                )}
                                                {isAdmin && (
                                                    <>
                                                        {!m.isAdmin && <button className="list-action-btn btn-promote" onClick={() => handleToggleAdmin(m.id, m.name, true)}>昇格</button>}
                                                        {m.isAdmin && m.name !== currentUser && <button className="list-action-btn btn-demote" onClick={() => handleToggleAdmin(m.id, m.name, false)}>解除</button>}
                                                        <button className="list-action-btn btn-delete" onClick={() => handleDeleteMember(m.id, m.name)}>削除</button>
                                                    </>
                                                )}
                                            </div>
                                        </div>
                                    ))}
                                </div>
                                <button className="btn-secondary" style={{marginTop:'auto'}} onClick={() => setShowMemberListModal(false)}>閉じる</button>
                            </div>
                        </div>
                    )}

                    {showAddMemberModal && (
                        <div className="modal-overlay" onClick={() => setShowAddMemberModal(false)}>
                            <div className="modal-content" style={{maxWidth: '450px'}} onClick={(e) => e.stopPropagation()}>
                                <h2>➕ 新規メンバー追加</h2>
                                <form onSubmit={handleAddMember} className="login-form">
                                    <div className="form-group"><label>名前</label><input value={newMemberName} onChange={e => setNewMemberName(e.target.value)} required /></div>
                                    <div className="form-group"><label>PIN (4桁)</label><input type="password" inputMode="numeric" pattern="[0-9]*" className="pin-input" value={newMemberPin} onChange={e => setNewMemberPin(e.target.value)} maxLength="4" required /></div>
                                    
                                    {isAdmin && (
                                        <div className="form-group">
                                            <label className="checkbox-container">
                                                <input type="checkbox" className="checkbox-input" checked={newMemberIsAdmin} onChange={e => setNewMemberIsAdmin(e.target.checked)} />
                                                <span className="checkbox-text">👑 管理者権限を付与する</span>
                                            </label>
                                        </div>
                                    )}
                                    
                                    <div style={{display:'flex', gap:'10px'}}>
                                        <button type="submit" className="btn-primary" style={{flex: 1}}>追加</button>
                                        <button type="button" className="btn-secondary" style={{flex: 1}} onClick={() => setShowAddMemberModal(false)}>キャンセル</button>
                                    </div>
                                </form>
                            </div>
                        </div>
                    )}

                    {showSwitchUserModal && (
                        <div className="modal-overlay" onClick={() => {
                            setShowSwitchUserModal(false);
                            setSwitchToMember('');
                            setPinInput('');
                        }}>
                            <div className="modal-content" style={{maxWidth: '400px'}} onClick={(e) => e.stopPropagation()}>
                                <h2>🔄 ユーザー切り替え</h2>
                                <p style={{marginBottom: '20px', color: 'var(--text-light)', textAlign: 'center'}}>
                                    <strong>{switchToMember}</strong> のPINコードを入力してください
                                </p>
                                <form onSubmit={handleConfirmSwitchUser} className="login-form">
                                    <input 
                                        type="password" 
                                        inputMode="numeric" 
                                        pattern="[0-9]*" 
                                        className="pin-input" 
                                        value={pinInput} 
                                        onChange={e => setPinInput(e.target.value)} 
                                        maxLength="4" 
                                        placeholder="••••" 
                                        required 
                                        autoFocus 
                                    />
                                    <div style={{display:'flex', gap:'10px', marginTop: '15px'}}>
                                        <button type="submit" className="btn-primary" style={{flex: 1}}>切り替え</button>
                                        <button 
                                            type="button" 
                                            className="btn-secondary" 
                                            style={{flex: 1}} 
                                            onClick={() => {
                                                setShowSwitchUserModal(false);
                                                setSwitchToMember('');
                                                setPinInput('');
                                            }}
                                        >
                                            キャンセル
                                        </button>
                                    </div>
                                </form>
                            </div>
                        </div>
                    )}

                    {showMyHistoryModal && (
                        <div className="modal-overlay" onClick={() => setShowMyHistoryModal(false)}>
                            <div className="modal-content" style={{maxWidth: '800px'}} onClick={(e) => e.stopPropagation()}>
                                <h2>👤 マイ履歴: {currentUser}</h2>
                                <div className="month-selector">
                                    <button onClick={() => setMyHistoryMonth(new Date(myHistoryMonth.getFullYear(), myHistoryMonth.getMonth() - 1, 1))}>←</button>
                                    <span>{myHistoryMonth.getFullYear()}年 {myHistoryMonth.getMonth() + 1}月</span>
                                    <button onClick={() => setMyHistoryMonth(new Date(myHistoryMonth.getFullYear(), myHistoryMonth.getMonth() + 1, 1))}>→</button>
                                </div>
                                
                                <div className="reservation-list" style={{maxHeight:'50vh', marginBottom:'20px'}}>
                                    {getReservationsForMonth(currentUser, myHistoryMonth.getFullYear(), myHistoryMonth.getMonth()).map(r => (
                                        <div key={r.id} className="reservation-item">
                                            <h4>{r.startDate || r.date}</h4>
                                            <div className="reservation-detail">
                                                {r.startDateTime ? `${r.startDateTime} - ${r.endDateTime}` : `${r.startTime} - ${r.endTime}`}
                                            </div>
                                            <div className="reservation-price">
                                                <span>¥{r.price.toLocaleString()} ({r.hours.toFixed(1)}h)</span>
                                                <div>
                                                    {renderStatusBadge(r.paymentStatus)}
                                                    {r.paymentStatus === 'unpaid' && (
                                                        <button className="pay-btn" onClick={() => {
                                                            const nextStatus = isAdmin ? 'confirmed' : 'pending';
                                                            const confirmMsg = isAdmin ? '支払いを記録し、受取済みにしますか？' : '支払い完了を管理者に通知しますか？';
                                                            if(window.confirm(confirmMsg)) updatePaymentStatus(r.id, nextStatus);
                                                        }}>支払い完了</button>
                                                    )}
                                                </div>
                                            </div>
                                        </div>
                                    ))}
                                    {getReservationsForMonth(currentUser, myHistoryMonth.getFullYear(), myHistoryMonth.getMonth()).length === 0 && <p style={{textAlign:'center', padding:'20px'}}>予約履歴がありません</p>}
                                </div>
                                <button className="btn-secondary" onClick={() => setShowMyHistoryModal(false)}>閉じる</button>
                            </div>
                        </div>
                    )}

                    {showAdminMode && isAdmin && (
                        <div className="modal-overlay" onClick={() => setShowAdminMode(false)}>
                            <div className="modal-content admin-modal-content" onClick={(e) => e.stopPropagation()}>
                                <h2>👑 管理者モード</h2>
                                
                                <div className="admin-tabs">
                                    <div className={`admin-tab ${adminTab === 'stats' ? 'active' : ''}`} onClick={() => setAdminTab('stats')}>📊 統計</div>
                                    <div className={`admin-tab ${adminTab === 'settings' ? 'active' : ''}`} onClick={() => setAdminTab('settings')}>⚙️ 料金設定</div>
                                </div>

                                {adminTab === 'stats' ? (
                                    <>
                                        <div className="month-selector">
                                            <button onClick={() => setSelectedMonth(new Date(selectedMonth.getFullYear(), selectedMonth.getMonth() - 1, 1))}>←</button>
                                            <span>{selectedMonth.getFullYear()}年 {selectedMonth.getMonth() + 1}月</span>
                                            <button onClick={() => setSelectedMonth(new Date(selectedMonth.getFullYear(), selectedMonth.getMonth() + 1, 1))}>→</button>
                                        </div>

                                        <div className="admin-stats-section">
                                            {(() => {
                                                const { stats, totalAllCount, totalAllHours, totalAllPrice } = getMemberStatsForMonth(selectedMonth.getFullYear(), selectedMonth.getMonth());
                                                const memberNames = Object.keys(stats).sort();
                                                return (
                                                    <>
                                                        <h3>📊 月間統計</h3>
                                                        <table className="stats-table">
                                                            <thead><tr><th>メンバー</th><th>回数</th><th>時間</th><th>金額</th><th>詳細</th></tr></thead>
                                                            <tbody>
                                                                {memberNames.map(name => (
                                                                    <tr key={name}>
                                                                        <td style={{fontWeight:'600'}}>{name}</td>
                                                                        <td>{stats[name].count}</td>
                                                                        <td>{stats[name].totalHours.toFixed(1)}h</td>
                                                                        <td>¥{stats[name].totalPrice.toLocaleString()}</td>
                                                                        <td><button className="header-btn" style={{background:'var(--primary)', color:'white', padding:'4px 8px', fontSize:'0.8rem'}} onClick={() => setSelectedMemberForStats(name)}>詳細</button></td>
                                                                    </tr>
                                                                ))}
                                                            </tbody>
                                                            <tfoot>
                                                                <tr>
                                                                    <td>合計</td>
                                                                    <td>{totalAllCount}回</td>
                                                                    <td>{totalAllHours.toFixed(1)}h</td>
                                                                    <td>¥{totalAllPrice.toLocaleString()}</td>
                                                                    <td>-</td>
                                                                </tr>
                                                            </tfoot>
                                                        </table>

                                                        {selectedMemberForStats && (
                                                            <div className="admin-detail-section">
                                                                <h3>📝 {selectedMemberForStats} の詳細</h3>
                                                                <div className="admin-reservation-list">
                                                                    {getReservationsForMonth(selectedMemberForStats, selectedMonth.getFullYear(), selectedMonth.getMonth()).map(r => (
                                                                        <div key={r.id} className="admin-reservation-item">
                                                                            <h4>{r.startDate || r.date}</h4>
                                                                            <div className="admin-reservation-detail">
                                                                                {r.startDateTime ? `${r.startDateTime} - ${r.endDateTime}` : `${r.startTime} - ${r.endTime}`}
                                                                            </div>
                                                                            <div className="admin-reservation-price">
                                                                                <span>¥{r.price.toLocaleString()} ({r.hours.toFixed(1)}h)</span>
                                                                                <div style={{display:'flex', gap:'5px', flexWrap:'wrap'}}>
                                                                                    {renderStatusBadge(r.paymentStatus)}
                                                                                    {r.paymentStatus === 'pending' && (
                                                                                        <button className="confirm-btn" style={{fontSize:'0.75rem', padding:'4px 8px'}} onClick={() => {
                                                                                            if(window.confirm('支払いを受け取り済みにしますか？')) updatePaymentStatus(r.id, 'confirmed');
                                                                                        }}>受取確認</button>
                                                                                    )}
                                                                                    {r.paymentStatus === 'unpaid' && (
                                                                                        <button className="confirm-btn" style={{background: 'var(--primary)', fontSize:'0.75rem', padding:'4px 8px'}} onClick={() => {
                                                                                            if(window.confirm('支払いを完了とし、受取済みにしますか？')) updatePaymentStatus(r.id, 'confirmed');
                                                                                        }}>受取完了</button>
                                                                                    )}
                                                                                    <button className="delete-btn" style={{fontSize:'0.75rem', padding:'4px 8px', marginTop:0, marginLeft:0}} onClick={() => handleDeleteReservation(r.id)}>削除</button>
                                                                                </div>
                                                                            </div>
                                                                        </div>
                                                                    ))}
                                                                </div>
                                                                <button className="btn-secondary" style={{width: '100%', padding:'8px', fontSize:'0.9rem'}} onClick={() => setSelectedMemberForStats('')}>詳細を閉じる</button>
                                                            </div>
                                                        )}
                                                    </>
                                                );
                                            })()}
                                        </div>
                                    </>
                                ) : (
                                    <div style={{flex: 1, overflowY: 'auto'}}>
                                        <h3 style={{color: 'var(--primary)', marginBottom: '12px', fontSize:'1.05rem'}}>⚙️ 料金プラン設定</h3>
                                        <div className="settings-list">
                                            {priceSettings.rates.map((rate, index) => (
                                                <div key={index} className="setting-item">
                                                    <span className="setting-label">{rate.hours}時間以内</span>
                                                    <div className="setting-input-group">
                                                        <input 
                                                            type="number" 
                                                            className="setting-input" 
                                                            value={rate.price} 
                                                            onChange={(e) => handleSettingChange(index, 'price', e.target.value)}
                                                        />
                                                        <span>円</span>
                                                    </div>
                                                </div>
                                            ))}
                                            <div className="setting-item" style={{borderTop: '2px solid var(--primary)', marginTop: '8px'}}>
                                                <span className="setting-label">以降24時間ごとの追加料金</span>
                                                <div className="setting-input-group">
                                                    <input 
                                                        type="number" 
                                                        className="setting-input" 
                                                        value={priceSettings.extraDayPrice} 
                                                        onChange={(e) => setPriceSettings({...priceSettings, extraDayPrice: Number(e.target.value)})}
                                                    />
                                                    <span>円</span>
                                                </div>
                                            </div>
                                        </div>
                                        <button className="btn-primary" style={{padding:'10px', fontSize:'1rem'}} onClick={handleSaveSettings}>設定を保存</button>
                                    </div>
                                )}

                                <button className="btn-secondary" style={{marginTop:'15px', flexShrink: 0, padding:'10px', fontSize:'1rem'}} onClick={() => {setShowAdminMode(false); setSelectedMemberForStats('');}}>管理者モード終了</button>
                            </div>
                        </div>
                    )}

                    <div className="container">
                        <div className="header">
                            <div className="header-left">
                                <h1><span className="car-icon">🚗</span>家族カーシェア管理</h1>
                            </div>
                            
                            <div style={{display: 'flex', flexDirection: 'column', alignItems: 'flex-end', gap: '10px', width: '100%'}}>
                                <div style={{display: 'flex', alignItems: 'center', flexWrap: 'wrap', justifyContent: 'flex-end', width: '100%'}}>
                                    
                                    <div className="notification-container">
                                        <button className="notification-btn" onClick={() => setShowNotifications(!showNotifications)}>
                                            🔔
                                            {notifications.length > 0 && <span className="badge">{notifications.length}</span>}
                                        </button>

                                        {showNotifications && (
                                            <>
                                                <div className="modal-overlay" onClick={() => setShowNotifications(false)} style={{zIndex: 19999}}></div>
                                                <div className="notification-dropdown" ref={notificationRef} style={{zIndex: 20000, right: window.innerWidth > 768 ? '0' : undefined}}>
                                                    <div className="notification-header">
                                                        {isAdmin ? '🔔 承認待ち一覧' : '🔔 未払い一覧'}
                                                    </div>
                                                    {notifications.length === 0 ? (
                                                        <div style={{textAlign:'center', padding:'10px', color:'var(--text-light)'}}>
                                                            {isAdmin ? '承認待ちはありません' : '未払いはありません'}
                                                        </div>
                                                    ) : (
                                                        notifications.map(n => (
                                                            <div key={n.id} className="notification-item">
                                                                <div className="notif-title">{n.member} - {n.startDate || n.date}</div>
                                                                <div className="notif-desc">¥{n.price.toLocaleString()} ({n.hours.toFixed(1)}h)</div>
                                                                <div className="notif-actions">
                                                                    {isAdmin ? (
                                                                        <button className="confirm-btn" onClick={() => {
                                                                            if(window.confirm('受取確認しますか？')) updatePaymentStatus(n.id, 'confirmed');
                                                                        }}>受取確認</button>
                                                                    ) : (
                                                                        <button className="pay-btn" onClick={() => {
                                                                            if(window.confirm('支払い完了を通知しますか？')) updatePaymentStatus(n.id, 'pending');
                                                                        }}>支払い完了</button>
                                                                    )}
                                                                </div>
                                                            </div>
                                                        ))
                                                    )}
                                                </div>
                                            </>
                                        )}
                                    </div>

                                    <span style={{marginRight: '10px', fontWeight: '600'}}>ログイン: <span style={{color:'var(--primary)'}}>{currentUser}</span></span>
                                    <button className="header-btn my-history-btn" onClick={() => setShowMyHistoryModal(true)}>👤 マイ履歴</button>
                                    {isAdmin && <button className="header-btn admin-mode-btn" onClick={() => setShowAdminMode(true)}>👑 管理者</button>}
                                    <button className="header-btn manage-members-btn" onClick={() => setShowMemberListModal(true)}>👥 一覧</button>
                                    <button className="header-btn add-member-btn" onClick={() => setShowAddMemberModal(true)}>➕ 追加</button>
                                    <button className="header-btn logout-btn" onClick={handleLogout}>ログアウト</button>
                                </div>
                                <div className="date-display">{new Date().toLocaleDateString('ja-JP', {year: 'numeric', month: 'long', day: 'numeric', weekday: 'long'})}</div>
                                <div style={{fontSize: '0.85rem', color: connectionStatus.includes('✅') ? '#27ae60' : '#e74c3c'}}>{connectionStatus}</div>
                            </div>
                        </div>

                        <div className="main-content">
                            <div className="calendar-section">
                                <div className="calendar-header">
                                    <h2>{currentDate.getFullYear()}年 {currentDate.getMonth() + 1}月</h2>
                                    <div className="nav-buttons">
                                        <button className="nav-btn" onClick={() => setCurrentDate(new Date(currentDate.getFullYear(), currentDate.getMonth() - 1))}>←</button>
                                        <button className="nav-btn" onClick={() => setCurrentDate(new Date(currentDate.getFullYear(), currentDate.getMonth() + 1))}>→</button>
                                    </div>
                                </div>
                                <div className="calendar">
                                    {['日','月','火','水','木','金','土'].map((d, i) => <div key={i} className={`day-header ${i===0?'sunday':i===6?'saturday':''}`}>{d}</div>)}
                                    {days.map((d, i) => {
                                        const dateRes = getReservationsForDate(d.date);
                                        const isStart = rangeStart && d.date.getTime() === rangeStart.getTime();
                                        const isEnd = rangeEnd && d.date.getTime() === rangeEnd.getTime();
                                        const isInRange = rangeStart && rangeEnd && d.date > rangeStart && d.date < rangeEnd;
                                        const isToday = new Date().toDateString() === d.date.toDateString();
                                        let cls = `day-cell ${!d.isCurrentMonth?'other-month':''} ${isToday?'today':''} ${d.date.getDay()===0?'sunday':d.date.getDay()===6?'saturday':''}`;
                                        if (isStart) cls += ' range-start'; if (isEnd) cls += ' range-end'; if (isInRange) cls += ' in-range';
                                        
                                        return (
                                            <div key={i} className={cls} onClick={() => handleDateClick(d.date)}>
                                                <div className="day-number">{d.date.getDate()}</div>
                                                <div className="day-reservations">
                                                    {dateRes.slice(0, 3).map((r, idx) => <div key={idx} className="reservation-indicator" />)}
                                                </div>
                                            </div>
                                        );
                                    })}
                                </div>
                            </div>

                            <div className="sidebar">
                                <div className="card">
                                    <h3>📅 {sidebarDate.getMonth() + 1}/{sidebarDate.getDate()}の予約</h3>
                                    <div className="reservation-list" style={{maxHeight:'300px'}}>
                                        {selectedDateReservations.length === 0 ? <p style={{color:'gray', textAlign:'center'}}>予約なし</p> : 
                                            selectedDateReservations.map(r => (
                                                <div key={r.id} className="reservation-item">
                                                    <h4>{r.member}</h4>
                                                    <div className="reservation-detail">{r.startDateTime ? `${r.startDateTime.split(' ')[1]} - ${r.endDateTime.split(' ')[1]}` : `${r.startTime} - ${r.endTime}`}</div>
                                                    <div className="reservation-price">¥{r.price.toLocaleString()}</div>
                                                    {(r.member === currentUser || isAdmin) && <button className="delete-btn" onClick={() => handleDeleteReservation(r.id)}>削除</button>}
                                                </div>
                                            ))
                                        }
                                    </div>
                                </div>

                                <div className="card">
                                    <h3>➕ 新規予約</h3>
                                    <form onSubmit={handleSubmit}>
                                        <div className="form-group">
                                            <label>使用者</label>
                                            <select value={formData.member} onChange={e => setFormData({...formData, member: e.target.value})}>
                                                {members.map(m => <option key={m.id} value={m.name}>{m.name}</option>)}
                                            </select>
                                        </div>
                                        <div className="form-group">
                                            <label>開始日時</label>
                                            <div style={{display: 'flex', gap: '10px', marginBottom: '10px'}}>
                                                <input type="date" value={formData.startDate} onChange={(e) => {
                                                    const newStartDate = e.target.value;
                                                    setFormData(prev => ({...prev, startDate: newStartDate, endDate: prev.endDate < newStartDate ? newStartDate : prev.endDate}));
                                                }} required style={{flex: 1}} />
                                            </div>
                                            <div style={{display:'flex', gap:'5px'}}>
                                                <select value={formData.startHour} onChange={e => setFormData({...formData, startHour: e.target.value})}>{Array.from({length:24},(_,i)=><option key={i} value={String(i).padStart(2,'0')}>{String(i).padStart(2,'0')}時</option>)}</select>
                                                <select value={formData.startMinute} onChange={e => setFormData({...formData, startMinute: e.target.value})}><option value="00">00分</option><option value="15">15分</option><option value="30">30分</option><option value="45">45分</option></select>
                                            </div>
                                        </div>
                                        <div className="form-group">
                                            <label>終了日時</label>
                                            <div style={{display: 'flex', gap: '10px', marginBottom: '10px'}}>
                                                <input type="date" value={formData.endDate} onChange={(e) => setFormData({...formData, endDate: e.target.value})} min={formData.startDate} required style={{flex: 1}} />
                                            </div>
                                            <div style={{display:'flex', gap:'5px'}}>
                                                <select value={formData.endHour} onChange={e => setFormData({...formData, endHour: e.target.value})}>{Array.from({length:24},(_,i)=><option key={i} value={String(i).padStart(2,'0')}>{String(i).padStart(2,'0')}時</option>)}</select>
                                                <select value={formData.endMinute} onChange={e => setFormData({...formData, endMinute: e.target.value})}><option value="00">00分</option><option value="15">15分</option><option value="30">30分</option><option value="45">45分</option></select>
                                            </div>
                                        </div>
                                        {calculatedPrice && <div className="calculation-display"><p>時間: {calculatedHours.toFixed(2)}h</p><p>料金: ¥{calculatedPrice.toLocaleString()}</p></div>}
                                        <button type="submit" className="btn-primary">予約する</button>
                                    </form>
                                </div>
                            </div>
                        </div>
                    </div>
                </>
            );
        };

        ReactDOM.render(<CarSharingApp />, document.getElementById('root'));
    </script>
</body>
</html>
