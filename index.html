<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ÂÆ∂Êóè„Ç´„Éº„Ç∑„Çß„Ç¢ÁÆ°ÁêÜ</title>
    <script src="https://cdn.jsdelivr.net/npm/react@18/umd/react.production.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/react-dom@18/umd/react-dom.production.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/@babel/standalone/babel.min.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-database-compat.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Outfit:wght@400;600;700&display=swap" rel="stylesheet">
    <style>
        :root {
            --primary: #2d5f8d;
            --primary-light: #4a8bc2;
            --secondary: #f39c12;
            --bg: #f8f9fc;
            --card-bg: #ffffff;
            --text: #1a1a2e;
            --text-light: #6c757d;
            --border: #e1e8ed;
            --success: #27ae60;
            --danger: #e74c3c;
            --btn-secondary-bg: #e2e8f0;
            --btn-secondary-text: #475569;
            --btn-secondary-hover: #cbd5e1;
            --shadow: 0 2px 4px rgba(0,0,0,0.1);
            --shadow-lg: 0 4px 12px rgba(0,0,0,0.15);
        }

        * { margin: 0; padding: 0; box-sizing: border-box; }
        body {
            font-family: 'Outfit', sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 20px;
            color: var(--text);
            -webkit-font-smoothing: antialiased;
        }
        
        button, input, select, textarea { font-family: 'Outfit', sans-serif; }

        .container { max-width: 1400px; margin: 0 auto; width: 100%; }
        .header {
            background: var(--card-bg); padding: 20px 30px; border-radius: 20px;
            margin-bottom: 30px; box-shadow: var(--shadow-lg);
            display: flex; justify-content: space-between; align-items: center;
            width: 100%;
        }
        
        .header-left { display: flex; align-items: center; gap: 20px; }
        .header h1 { 
            font-size: 2.2rem; 
            font-weight: 700; 
            color: var(--primary); 
            display: flex; 
            align-items: center; 
            gap: 10px; 
            margin: 0; 
            white-space: nowrap; /* „Çø„Ç§„Éà„É´„ÅÆÊîπË°å„ÇíÈò≤„Åê */
        }
        .car-icon { font-size: 2.5rem; }
        .date-display { font-family: monospace; font-size: 1.1rem; color: var(--text-light); }
        .main-content { display: grid; grid-template-columns: 1fr 350px; gap: 30px; width: 100%; }
        
        /* Notification Styles */
        .notification-container { position: relative; margin-right: 15px; display: flex; align-items: center; }
        .notification-btn {
            background: none; border: none; font-size: 1.6rem; cursor: pointer;
            position: relative; padding: 5px; line-height: 1;
        }
        .badge {
            position: absolute; top: -2px; right: -2px;
            background: var(--danger); color: white;
            font-size: 0.7rem; font-weight: 700;
            width: 18px; height: 18px; border-radius: 50%;
            display: flex; align-items: center; justify-content: center;
            box-shadow: 0 2px 5px rgba(0,0,0,0.2);
        }

        .notification-dropdown {
            position: absolute; top: 130%; right: -50px; width: 320px;
            background: white; border-radius: 15px;
            box-shadow: 0 10px 40px rgba(0,0,0,0.2);
            z-index: 1000; padding: 15px; border: 1px solid var(--border);
        }
        .notification-dropdown::before {
            content: ''; position: absolute; top: -8px; right: 58px;
            width: 16px; height: 16px; background: white;
            transform: rotate(45deg); border-left: 1px solid var(--border); border-top: 1px solid var(--border);
        }
        .notification-header { font-weight: 700; color: var(--primary); margin-bottom: 10px; border-bottom: 2px solid var(--bg); padding-bottom: 8px; }
        .notification-item {
            padding: 10px; border-bottom: 1px solid var(--border);
            display: flex; flex-direction: column; gap: 5px;
        }
        .notification-item:last-child { border-bottom: none; }
        .notif-title { font-weight: 600; font-size: 0.95rem; }
        .notif-desc { font-size: 0.85rem; color: var(--text-light); }
        .notif-actions { display: flex; justify-content: flex-end; margin-top: 5px; }
        
        /* Calendar Styles */
        .calendar-section { background: var(--card-bg); padding: 30px; border-radius: 20px; box-shadow: var(--shadow-lg); }
        .calendar-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 25px; }
        .calendar-header h2 { font-size: 1.5rem; color: var(--primary); }
        .nav-buttons { display: flex; gap: 10px; }
        .nav-btn { background: var(--primary); color: white; border: none; padding: 10px 20px; border-radius: 10px; cursor: pointer; font-weight: 600; }
        .calendar { display: grid; grid-template-columns: repeat(7, 1fr); gap: 10px; }
        .day-header { text-align: center; font-weight: 600; padding: 15px 5px; color: var(--primary); font-size: 0.9rem; }
        .day-header.sunday { color: #e74c3c; }
        .day-header.saturday { color: #3498db; }
        .day-cell { 
            aspect-ratio: 1; 
            border: 2px solid var(--border); 
            border-radius: 12px; 
            padding: 8px; 
            cursor: pointer; 
            position: relative; 
            background: var(--bg);
            min-height: 60px;
            display: flex;
            flex-direction: column;
            -webkit-tap-highlight-color: transparent;
        }
        .day-cell.other-month { opacity: 0.3; }
        .day-cell.range-start { background: var(--primary); color: white; border-color: var(--primary); border-radius: 12px 0 0 12px; z-index: 1; }
        .day-cell.range-end { background: var(--primary); color: white; border-color: var(--primary); border-radius: 0 12px 12px 0; z-index: 1; }
        .day-cell.range-start.range-end { border-radius: 12px; }
        .day-cell.in-range { background: rgba(45, 95, 141, 0.15); color: var(--text); border-radius: 0; border-color: transparent; }
        .day-cell.today { background: #fff3cd; border-color: var(--secondary); font-weight: 700; }
        .day-cell.today.range-start, .day-cell.today.range-end { background: var(--primary); color: white; border-color: var(--secondary); }
        .day-cell.sunday .day-number { color: #e74c3c; }
        .day-cell.saturday .day-number { color: #3498db; }
        .day-cell.range-start .day-number, .day-cell.range-end .day-number { color: white !important; }
        .day-number { font-weight: 600; font-size: 0.95rem; margin-bottom: 5px; }
        .day-reservations { display: flex; flex-direction: column; gap: 2px; margin-top: auto; }
        .reservation-indicator { width: 100%; height: 4px; border-radius: 2px; background: var(--secondary); }

        /* Sidebar & Forms */
        .sidebar { display: flex; flex-direction: column; gap: 20px; }
        .card { background: var(--card-bg); padding: 25px; border-radius: 20px; box-shadow: var(--shadow-lg); }
        .card h3 { font-size: 1.3rem; margin-bottom: 20px; color: var(--primary); }
        .form-group { margin-bottom: 20px; }
        .form-group label { display: block; margin-bottom: 8px; font-weight: 600; color: var(--text); font-size: 0.95rem; }
        .form-group input, .form-group select { width: 100%; padding: 12px 15px; border: 2px solid var(--border); border-radius: 10px; font-size: 1rem; }
        .form-group input:focus, .form-group select:focus { outline: none; border-color: var(--primary); }
        
        /* Buttons */
        .btn-primary { width: 100%; background: var(--primary); color: white; border: none; padding: 15px; border-radius: 12px; font-size: 1.1rem; font-weight: 600; cursor: pointer; margin-top: 10px; white-space: nowrap; }
        .btn-secondary { width: 100%; background: var(--btn-secondary-bg); color: var(--btn-secondary-text); border: none; padding: 15px; border-radius: 12px; font-size: 1.1rem; font-weight: 600; cursor: pointer; margin-top: 10px; white-space: nowrap; }

        .reservation-list { max-height: 400px; overflow-y: auto; -webkit-overflow-scrolling: touch; }
        .reservation-item { padding: 15px; background: var(--bg); border-radius: 12px; margin-bottom: 12px; border-left: 4px solid var(--secondary); }
        .reservation-item h4 { font-size: 1.05rem; margin-bottom: 8px; color: var(--primary); }
        .reservation-detail { font-size: 0.9rem; color: var(--text-light); margin-bottom: 4px; font-family: monospace; }
        .reservation-price { font-size: 1.2rem; font-weight: 700; color: var(--success); margin-top: 8px; display: flex; justify-content: space-between; align-items: center;}
        
        .delete-btn { background: var(--danger); color: white; border: none; padding: 8px 15px; border-radius: 8px; font-weight: 600; cursor: pointer; margin-top: 10px; font-size: 0.9rem; }
        
        /* Payment Status Styles */
        .payment-status { font-size: 0.8rem; padding: 4px 8px; border-radius: 6px; font-weight: 600; }
        .status-unpaid { background: #ffebee; color: #c62828; }
        .status-pending { background: #fff3e0; color: #ef6c00; }
        .status-paid { background: #e8f5e9; color: #2e7d32; }
        
        .pay-btn { background: var(--secondary); color: white; border: none; padding: 6px 12px; border-radius: 8px; font-size: 0.85rem; cursor: pointer; margin-left: 10px; }
        .confirm-btn { background: var(--success); color: white; border: none; padding: 6px 12px; border-radius: 8px; font-size: 0.85rem; cursor: pointer; margin-left: 10px; }

        /* Modals */
        .modal-overlay { position: fixed; top: 0; left: 0; right: 0; bottom: 0; background: rgba(0, 0, 0, 0.7); display: flex; align-items: center; justify-content: center; z-index: 1000; }
        .modal-content { 
            background: white; 
            padding: 30px; 
            border-radius: 20px; 
            box-shadow: 0 20px 60px rgba(0,0,0,0.3); 
            max-width: 450px; 
            width: 90%; 
            max-height: 85vh; 
            overflow-y: auto; 
            display: flex; 
            flex-direction: column;
            -webkit-overflow-scrolling: touch;
        }
        
        .modal-content h2 { color: var(--primary); margin-bottom: 20px; text-align: center; font-size: 1.6rem; flex-shrink: 0; }
        
        /* Modal specific scrollable areas */
        .member-list { display: flex; flex-direction: column; gap: 10px; overflow-y: auto; margin-bottom: 20px; flex: 1; padding-right: 5px; -webkit-overflow-scrolling: touch; }
        .member-item { display: flex; justify-content: space-between; align-items: center; padding: 12px; background: var(--bg); border-radius: 8px; border: 2px solid var(--border); flex-shrink: 0; }
        .member-name { font-weight: 600; color: var(--text); }
        
        /* Buttons in Header */
        .header-btn { border: none; padding: 8px 16px; border-radius: 8px; cursor: pointer; font-weight: 600; font-size: 0.9rem; margin-left: 5px; }
        .logout-btn { background: var(--danger); color: white; }
        .manage-members-btn { background: var(--primary); color: white; }
        .add-member-btn { background: var(--success); color: white; }
        .admin-mode-btn { background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white; }
        .my-history-btn { background: var(--secondary); color: white; }

        /* Small action buttons in lists */
        .list-action-btn { border: none; padding: 6px 12px; border-radius: 6px; cursor: pointer; font-size: 0.85rem; font-weight: 600; margin-left: 5px; white-space: nowrap; }
        .btn-promote { background: var(--secondary); color: white; }
        .btn-demote { background: var(--text-light); color: white; }
        .btn-delete { background: var(--danger); color: white; }

        /* Stats Table */
        .stats-table { width: 100%; border-collapse: collapse; margin-top: 15px; }
        .stats-table th, .stats-table td { padding: 12px; text-align: left; border-bottom: 1px solid var(--border); }
        .stats-table th { background: var(--bg); font-weight: 600; color: var(--primary); }
        .stats-table tfoot td { font-weight: 700; background: #fff3cd; border-top: 2px solid var(--secondary); }

        .month-selector { display: flex; align-items: center; gap: 10px; margin-bottom: 20px; justify-content: center; flex-shrink: 0; }
        .month-selector button { padding: 8px 15px; background: var(--primary); color: white; border: none; border-radius: 8px; cursor: pointer; font-weight: 600; }
        
        /* Admin Mode Tabs */
        .admin-tabs { display: flex; gap: 10px; margin-bottom: 20px; justify-content: center; }
        .admin-tab { 
            padding: 10px 20px; 
            border: 2px solid transparent; 
            border-radius: 20px; 
            background: var(--bg); 
            cursor: pointer; 
            font-weight: 600; 
            color: var(--text-light);
        }
        .admin-tab.active { 
            background: var(--primary); 
            color: white; 
            box-shadow: var(--shadow);
        }

        /* Settings Form */
        .settings-list {
            display: flex;
            flex-direction: column;
            gap: 15px;
        }
        .setting-item {
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 15px;
            background: var(--bg);
            border-radius: 12px;
            border: 2px solid var(--border);
        }
        .setting-label {
            font-weight: 600;
            color: var(--text);
        }
        .setting-input-group {
            display: flex;
            align-items: center;
            gap: 10px;
        }
        .setting-input {
            width: 100px;
            padding: 8px;
            border-radius: 8px;
            border: 2px solid var(--border);
            text-align: right;
            font-size: 1rem;
        }

        /* Forms */
        .login-form { display: flex; flex-direction: column; gap: 15px; }
        .pin-input { padding: 15px; font-size: 1.5rem; text-align: center; border: 2px solid var(--border); border-radius: 10px; font-family: monospace; letter-spacing: 0.5em; }
        .pin-input:focus { outline: none; border-color: var(--primary); }
        
        /* Checkbox styling */
        .checkbox-container {
            display: flex;
            align-items: center;
            gap: 12px;
            padding: 12px;
            border: 2px solid var(--border);
            border-radius: 10px;
            cursor: pointer;
            background: var(--bg);
        }
        .checkbox-input { width: 20px; height: 20px; accent-color: var(--primary); cursor: pointer; margin: 0; }
        .checkbox-text { font-weight: 600; color: var(--text); user-select: none; }

        .calculation-display { background: #fff3cd; padding: 15px; border-radius: 10px; margin-top: 15px; border-left: 4px solid var(--secondary); }
        .calculation-display p { margin: 5px 0; font-size: 0.95rem; }
        
        /* ===== „Çπ„Éû„ÉõÂØæÂøú„ÅÆÂº∑Âåñ ===== */
        @media (max-width: 768px) {
            body { padding: 10px; }
            
            /* „Ç≥„É≥„ÉÜ„Éä„Å®„Éò„ÉÉ„ÉÄ„Éº„ÅÆÊ®™ÂπÖ„ÇíÁµ±‰∏Ä */
            .container { padding: 0; }
            
            /* „Éò„ÉÉ„ÉÄ„ÉºË™øÊï¥ */
            .header { 
                flex-direction: column; 
                gap: 15px; 
                padding: 15px; 
            }
            .header-left { 
                flex-direction: column; 
                text-align: center;
                width: 100%;
            }
            .header h1 { 
                font-size: 1.5rem;
                flex-direction: column;
                gap: 5px;
            }
            .car-icon { font-size: 2rem; }
            .date-display { font-size: 0.85rem; }
            
            /* ÈÄöÁü•„Éâ„É≠„ÉÉ„Éó„ÉÄ„Ç¶„É≥ */
            .notification-dropdown {
                right: -20px;
                width: 280px;
            }
            .notification-dropdown::before {
                right: 28px;
            }
            
            /* „Éò„ÉÉ„ÉÄ„Éº„Éú„Çø„É≥ */
            .header-btn { 
                font-size: 0.75rem;
                padding: 6px 10px;
                margin: 3px;
            }
            
            /* „É°„Ç§„É≥„Ç≥„É≥„ÉÜ„É≥„ÉÑ */
            .main-content { 
                grid-template-columns: 1fr;
                gap: 15px;
            }
            
            /* „Ç´„É¨„É≥„ÉÄ„Éº„Çª„ÇØ„Ç∑„Éß„É≥ */
            .calendar-section { 
                padding: 15px; 
            }
            .calendar-header { 
                flex-direction: column;
                gap: 10px;
                margin-bottom: 15px;
            }
            .calendar-header h2 { 
                font-size: 1.2rem; 
            }
            .nav-buttons { 
                width: 100%;
                justify-content: center;
            }
            .nav-btn { 
                padding: 8px 20px;
                font-size: 0.9rem;
            }
            
            /* „Ç´„É¨„É≥„ÉÄ„Éº„Ç∞„É™„ÉÉ„Éâ - „Çπ„Éû„ÉõÁî®ÊúÄÈÅ©Âåñ */
            .calendar { 
                gap: 4px;
            }
            .day-header { 
                padding: 8px 2px;
                font-size: 0.75rem;
            }
            .day-cell { 
                padding: 4px;
                border-radius: 8px;
                min-height: 50px;
                border-width: 1px;
            }
            .day-number { 
                font-size: 0.8rem;
                margin-bottom: 2px;
            }
            .day-reservations { 
                gap: 1px; 
            }
            .reservation-indicator { 
                height: 3px;
            }
            
            /* „Çµ„Ç§„Éâ„Éê„Éº„Éª„Ç´„Éº„Éâ */
            .card { 
                padding: 15px; 
            }
            .card h3 { 
                font-size: 1.1rem;
                margin-bottom: 15px;
            }
            
            /* „Éï„Ç©„Éº„É† */
            .form-group { 
                margin-bottom: 15px; 
            }
            .form-group label { 
                font-size: 0.85rem; 
            }
            .form-group input, 
            .form-group select { 
                padding: 10px;
                font-size: 0.9rem;
            }
            
            /* ‰∫àÁ¥Ñ„É™„Çπ„Éà */
            .reservation-list { 
                max-height: 300px; 
            }
            .reservation-item { 
                padding: 12px; 
            }
            .reservation-item h4 { 
                font-size: 0.95rem; 
            }
            .reservation-detail { 
                font-size: 0.8rem; 
            }
            .reservation-price { 
                font-size: 1rem;
                flex-direction: column;
                align-items: flex-start;
                gap: 8px;
            }
            
            /* „Éú„Çø„É≥ */
            .btn-primary, 
            .btn-secondary { 
                padding: 12px;
                font-size: 1rem;
            }
            .delete-btn,
            .pay-btn,
            .confirm-btn { 
                font-size: 0.75rem;
                padding: 5px 10px;
            }
            
            /* „É¢„Éº„ÉÄ„É´ */
            .modal-content { 
                padding: 20px;
                width: 95%;
                max-height: 90vh;
            }
            .modal-content h2 { 
                font-size: 1.3rem;
                margin-bottom: 15px;
            }
            
            /* „É°„É≥„Éê„Éº„Ç¢„Ç§„ÉÜ„É† */
            .member-item { 
                padding: 10px;
                flex-direction: column;
                gap: 8px;
                align-items: flex-start;
            }
            .list-action-btn { 
                font-size: 0.75rem;
                padding: 5px 10px;
            }
            
            /* Áµ±Ë®à„ÉÜ„Éº„Éñ„É´ */
            .stats-table { 
                font-size: 0.85rem; 
            }
            .stats-table th, 
            .stats-table td { 
                padding: 8px 4px; 
            }
            
            /* ÊúàÈÅ∏Êäû */
            .month-selector { 
                gap: 8px; 
            }
            .month-selector button { 
                padding: 6px 12px;
                font-size: 0.9rem;
            }
            .month-selector span { 
                font-size: 1rem !important;
                min-width: 120px !important;
            }
            
            /* ÁÆ°ÁêÜËÄÖ„Çø„Éñ */
            .admin-tabs { 
                gap: 8px;
                flex-wrap: wrap;
            }
            .admin-tab { 
                padding: 8px 15px;
                font-size: 0.85rem;
            }
            
            /* Ë®≠ÂÆö */
            .setting-item { 
                padding: 12px;
                flex-direction: column;
                align-items: flex-start;
                gap: 8px;
            }
            .setting-label { 
                font-size: 0.9rem; 
            }
            .setting-input { 
                width: 80px;
                padding: 6px;
                font-size: 0.9rem;
            }
            
            /* Ë®àÁÆóË°®Á§∫ */
            .calculation-display { 
                padding: 12px; 
            }
            .calculation-display p { 
                font-size: 0.85rem; 
            }
        }
        
        /* Ê•µÂ∞èÁîªÈù¢Ôºà320px‰ª•‰∏ãÔºâ„ÅÆËøΩÂä†Ë™øÊï¥ */
        @media (max-width: 360px) {
            .calendar { 
                gap: 2px; 
            }
            .day-cell { 
                padding: 2px;
                min-height: 45px;
            }
            .day-number { 
                font-size: 0.7rem; 
            }
            .day-header { 
                font-size: 0.65rem;
                padding: 6px 1px;
            }
        }

        /* „Éá„Çπ„ÇØ„Éà„ÉÉ„Éó„ÅÆ„Åø„ÅÆ„Éõ„Éê„ÉºÂäπÊûú */
        @media (hover: hover) and (pointer: fine) {
            .notification-btn:hover { transform: scale(1.1); }
            .nav-btn:hover { background: var(--primary-light); transform: translateY(-2px); box-shadow: var(--shadow); }
            .day-cell:hover { border-color: var(--primary); transform: scale(1.05); box-shadow: var(--shadow); z-index: 2; }
            .btn-primary:hover { transform: translateY(-2px); box-shadow: var(--shadow-lg); }
            .btn-secondary:hover { background: var(--btn-secondary-hover); transform: translateY(-2px); }
            .delete-btn:hover { background: #c0392b; transform: scale(1.05); }
            .pay-btn:hover { background: #e67e22; }
            .confirm-btn:hover { background: #219150; }
            .checkbox-container:hover { border-color: var(--primary); }
            .stats-table tr:hover { background: var(--bg); }
            .logout-btn:hover { background: #c0392b; transform: translateY(-2px); }
            .manage-members-btn:hover { background: var(--primary-light); transform: translateY(-2px); }
            .add-member-btn:hover { background: #219150; transform: translateY(-2px); }
            .admin-mode-btn:hover { transform: translateY(-2px); box-shadow: 0 4px 12px rgba(102, 126, 234, 0.4); }
            .my-history-btn:hover { background: #e67e22; transform: translateY(-2px); }
            .month-selector button:hover { background: var(--primary-light); }
        }
    </style>
</head>
<body>
    <div id="root"></div>

    <script type="text/babel">
        const { useState, useEffect, useRef, useMemo, useCallback } = React;

        // ÂàùÊúü„É°„É≥„Éê„Éº„Éá„Éº„Çø
        const INITIAL_MEMBERS = [
            { name: 'ÁÆ°ÁêÜËÄÖ', pin: '0000', isAdmin: true }
        ];

        // „Éá„Éï„Ç©„É´„ÉàÊñôÈáëË®≠ÂÆöÔºàFirebase„Å´„Å™„ÅÑÂ†¥Âêà„Å´‰ΩøÁî®Ôºâ
        const DEFAULT_PRICE_SETTINGS = {
            rates: [
                { hours: 1, price: 500 },
                { hours: 3, price: 1000 },
                { hours: 6, price: 2000 },
                { hours: 12, price: 2500 },
                { hours: 24, price: 3000 },
                { hours: 48, price: 6000 }
            ],
            extraDayPrice: 3000 // 48ÊôÇÈñì‰ª•Èôç„ÅÆ24ÊôÇÈñìÊØé„ÅÆËøΩÂä†ÊñôÈáë
        };

        // ------------------------------------------------------------------
        // ‚ñº ÈáçË¶ÅÔºö„Åì„Åì„Å´„ÅÇ„Å™„Åü„ÅÆFirebaseË®≠ÂÆö„ÇíË≤º„Çä‰ªò„Åë„Å¶„Åè„Å†„Åï„ÅÑ ‚ñº
        // ------------------------------------------------------------------
        const firebaseConfig = {
            apiKey: "AIzaSyDemoKeyForCarSharing123456789", // „Åì„Åì„ÇíËá™ÂàÜ„ÅÆ„Ç≠„Éº„Å´
            authDomain: "car-sharing-demo.firebaseapp.com",
            databaseURL: "https://family-car-share-8a1c4-default-rtdb.asia-southeast1.firebasedatabase.app/",
            projectId: "car-sharing-demo",
            storageBucket: "car-sharing-demo.appspot.com",
            messagingSenderId: "123456789012",
            appId: "1:123456789012:web:abc123def456"
        };
        // ------------------------------------------------------------------

        // FirebaseÂàùÊúüÂåñ
        let database;
        let isFirebaseReady = false;
        try {
            if (!firebase.apps.length) {
                firebase.initializeApp(firebaseConfig);
            }
            database = firebase.database();
            isFirebaseReady = true;
        } catch (error) {
            console.error('FirebaseÂàùÊúüÂåñ„Ç®„É©„Éº:', error);
        }

        const CarSharingApp = () => {
            const [currentDate, setCurrentDate] = useState(new Date());
            const [rangeStart, setRangeStart] = useState(new Date());
            const [rangeEnd, setRangeEnd] = useState(new Date());
            const [reservations, setReservations] = useState([]);
            const [formData, setFormData] = useState(() => {
                const today = new Date();
                const year = today.getFullYear();
                const month = String(today.getMonth() + 1).padStart(2, '0');
                const day = String(today.getDate()).padStart(2, '0');
                const localDateString = `${year}-${month}-${day}`;
                return {
                    member: '',
                    startDate: localDateString,
                    startHour: '12', startMinute: '00',
                    endDate: localDateString,
                    endHour: '12', endMinute: '00'
                };
            });
            const [calculatedPrice, setCalculatedPrice] = useState(null);
            const [calculatedHours, setCalculatedHours] = useState(null);
            const [isLoading, setIsLoading] = useState(true);
            const [connectionStatus, setConnectionStatus] = useState('Êé•Á∂ö‰∏≠...');
            
            // User & Auth State
            const [currentUser, setCurrentUser] = useState(null);
            const [isAuthenticated, setIsAuthenticated] = useState(false);
            const [showLoginModal, setShowLoginModal] = useState(true);
            const [pinInput, setPinInput] = useState('');
            const [selectedMemberForLogin, setSelectedMemberForLogin] = useState('');
            const [members, setMembers] = useState([]);
            const [isAdmin, setIsAdmin] = useState(false);

            // Modals State
            const [showMemberListModal, setShowMemberListModal] = useState(false);
            const [showAddMemberModal, setShowAddMemberModal] = useState(false);
            const [showAdminMode, setShowAdminMode] = useState(false);
            const [showMyHistoryModal, setShowMyHistoryModal] = useState(false);
            const [showNotifications, setShowNotifications] = useState(false);

            // Notification Ref for clicking outside
            const notificationRef = useRef(null);

            // New Member Input
            const [newMemberName, setNewMemberName] = useState('');
            const [newMemberPin, setNewMemberPin] = useState('');
            const [newMemberIsAdmin, setNewMemberIsAdmin] = useState(false);

            // Admin & Stats State
            const [selectedMonth, setSelectedMonth] = useState(new Date());
            const [selectedMemberForStats, setSelectedMemberForStats] = useState('');
            const [adminTab, setAdminTab] = useState('stats'); // 'stats' or 'settings'
            
            // Price Settings State
            const [priceSettings, setPriceSettings] = useState(DEFAULT_PRICE_SETTINGS);
            
            // My History State
            const [myHistoryMonth, setMyHistoryMonth] = useState(new Date());

            // --- Effects ---

            useEffect(() => {
                const savedUser = localStorage.getItem('authenticatedUser');
                if (savedUser) {
                    setCurrentUser(savedUser);
                    setIsAuthenticated(true);
                    setShowLoginModal(false);
                }
            }, []);

            // Click outside to close notifications logic
            useEffect(() => {
                const handleClickOutside = (event) => {
                    if (notificationRef.current && !notificationRef.current.contains(event.target)) {
                        setShowNotifications(false);
                    }
                };
                document.addEventListener('mousedown', handleClickOutside);
                return () => {
                    document.removeEventListener('mousedown', handleClickOutside);
                };
            }, []);

            useEffect(() => {
                if (currentUser && members.length > 0) {
                    const member = members.find(m => m.name === currentUser);
                    if (member) setIsAdmin(member.isAdmin || false);
                }
            }, [members, currentUser]);

            // Load Data from Firebase
            useEffect(() => {
                if (!isFirebaseReady) {
                    setConnectionStatus('FirebaseË®≠ÂÆö„ÅåÂøÖË¶Å„Åß„Åô');
                    setIsLoading(false);
                    return;
                }

                // „É°„É≥„Éê„ÉºË™≠„ÅøËæº„Åø
                const membersRef = database.ref('members');
                membersRef.on('value', (snapshot) => {
                    const data = snapshot.val();
                    if (data) {
                        const membersList = Object.keys(data).map(key => ({
                            id: key,
                            name: data[key].name,
                            pin: data[key].pin,
                            isAdmin: data[key].isAdmin || false
                        }));
                        setMembers(membersList);
                        if (membersList.length > 0 && !selectedMemberForLogin) {
                            setSelectedMemberForLogin(membersList[0].name);
                        }
                    } else {
                        INITIAL_MEMBERS.forEach(member => {
                            membersRef.push({ name: member.name, pin: member.pin, isAdmin: member.isAdmin || false });
                        });
                    }
                });

                // ‰∫àÁ¥Ñ„Éá„Éº„ÇøË™≠„ÅøËæº„Åø
                const reservationsRef = database.ref('reservations');
                reservationsRef.on('value', (snapshot) => {
                    const data = snapshot.val();
                    if (data) {
                        const reservationsList = Object.keys(data).map(key => ({
                            ...data[key],
                            id: key,
                            paymentStatus: data[key].paymentStatus || 'unpaid' 
                        }));
                        setReservations(reservationsList);
                    } else {
                        setReservations([]);
                    }
                    setIsLoading(false);
                });

                // ÊñôÈáëË®≠ÂÆöË™≠„ÅøËæº„Åø
                const settingsRef = database.ref('settings/prices');
                settingsRef.on('value', (snapshot) => {
                    const data = snapshot.val();
                    if (data) {
                        setPriceSettings(data);
                    }
                });
                
                // Êé•Á∂öÁä∂ÊÖã
                const connectedRef = database.ref('.info/connected');
                connectedRef.on('value', (s) => setConnectionStatus(s.val() ? '‚úÖ ÂêåÊúü‰∏≠' : '‚ö†Ô∏è „Ç™„Éï„É©„Ç§„É≥'));
                
                return () => { 
                    membersRef.off(); 
                    reservationsRef.off();
                    settingsRef.off();
                    connectedRef.off(); 
                };
            }, []);

            // ÊñôÈáëË®àÁÆó„É≠„Ç∏„ÉÉ„ÇØ (ÂãïÁöÑË®≠ÂÆöÂØæÂøú) - useCallback„ÅßÊúÄÈÅ©Âåñ
            const calculatePrice = useCallback((hours, settings) => {
                const { rates, extraDayPrice } = settings;
                
                // Ë®≠ÂÆö„Åï„Çå„Åü„É¨„Éº„Éà„ÅÆ‰∏≠„Åß„ÄÅÊôÇÈñì„ÅåÂèé„Åæ„Çã„ÇÇ„ÅÆ„ÇíÊé¢„Åô
                for (const rate of rates) {
                    if (hours <= rate.hours) {
                        return rate.price;
                    }
                }
                
                // Ë®≠ÂÆö„Åï„Çå„ÅüÊúÄÂ§ßÊôÇÈñì„ÇíË∂Ö„Åà„ÇãÂ†¥Âêà
                const maxRate = rates[rates.length - 1];
                const extraHours = hours - maxRate.hours;
                const extraDays = Math.ceil(extraHours / 24);
                return maxRate.price + (extraDays * extraDayPrice);
            }, []);

            // ÊñôÈáëË®àÁÆó„Ç®„Éï„Çß„ÇØ„Éà
            useEffect(() => {
                if (formData.startDate && formData.startHour !== '' && formData.startMinute !== '' && 
                    formData.endDate && formData.endHour !== '' && formData.endMinute !== '') {
                    const startDateTime = new Date(`${formData.startDate}T${formData.startHour}:${formData.startMinute}:00`);
                    const endDateTime = new Date(`${formData.endDate}T${formData.endHour}:${formData.endMinute}:00`);
                    if (endDateTime > startDateTime) {
                        const diffHours = (endDateTime - startDateTime) / (1000 * 60 * 60);
                        setCalculatedHours(diffHours);
                        // ÁèæÂú®„ÅÆË®≠ÂÆö„Çí‰Ωø„Å£„Å¶Ë®àÁÆó
                        setCalculatedPrice(calculatePrice(diffHours, priceSettings));
                    } else {
                        setCalculatedPrice(null); setCalculatedHours(null);
                    }
                } else {
                    setCalculatedPrice(null); setCalculatedHours(null);
                }
            }, [formData, priceSettings, calculatePrice]);

            useEffect(() => {
                if (!rangeStart) return;
                const formatDate = (date) => {
                    const year = date.getFullYear();
                    const month = String(date.getMonth() + 1).padStart(2, '0');
                    const day = String(date.getDate()).padStart(2, '0');
                    return `${year}-${month}-${day}`;
                };
                const startStr = formatDate(rangeStart);
                const endStr = rangeEnd ? formatDate(rangeEnd) : startStr;
                setFormData(prev => ({ ...prev, startDate: startStr, endDate: endStr }));
            }, [rangeStart, rangeEnd]);

            useEffect(() => {
                if (currentUser) setFormData(prev => ({ ...prev, member: currentUser }));
            }, [currentUser]);

            // --- Handlers - useCallback„ÅßÊúÄÈÅ©Âåñ ---

            const handleDateClick = useCallback((date) => {
                setRangeStart(prevStart => {
                    setRangeEnd(prevEnd => {
                        if ((!prevStart && !prevEnd) || (prevStart && prevEnd)) {
                            return null;
                        } else if (prevStart && !prevEnd) {
                            if (date < prevStart) return null;
                            else return date;
                        }
                        return prevEnd;
                    });
                    
                    if ((!prevStart && !rangeEnd) || (prevStart && rangeEnd)) {
                        return date;
                    } else if (prevStart && !rangeEnd) {
                        if (date < prevStart) return date;
                        else return prevStart;
                    }
                    return prevStart;
                });
            }, [rangeEnd]);

            const handleLogin = useCallback((e) => {
                e.preventDefault();
                const member = members.find(m => m.name === selectedMemberForLogin);
                if (member && member.pin === pinInput) {
                    setCurrentUser(selectedMemberForLogin);
                    setIsAuthenticated(true);
                    setIsAdmin(member.isAdmin || false);
                    setShowLoginModal(false);
                    localStorage.setItem('authenticatedUser', selectedMemberForLogin);
                    setPinInput('');
                    alert(`${selectedMemberForLogin}„Å®„Åó„Å¶„É≠„Ç∞„Ç§„É≥„Åó„Åæ„Åó„Åü`);
                } else {
                    alert('PIN„Ç≥„Éº„Éâ„ÅåÊ≠£„Åó„Åè„ÅÇ„Çä„Åæ„Åõ„Çì'); setPinInput('');
                }
            }, [members, selectedMemberForLogin, pinInput]);

            const handleLogout = useCallback(() => {
                if (window.confirm('„É≠„Ç∞„Ç¢„Ç¶„Éà„Åó„Åæ„Åô„ÅãÔºü')) {
                    setCurrentUser(null); setIsAuthenticated(false); setIsAdmin(false);
                    setShowLoginModal(true); setShowAdminMode(false); setShowMyHistoryModal(false);
                    localStorage.removeItem('authenticatedUser'); setPinInput('');
                }
            }, []);

            const updatePaymentStatus = useCallback(async (id, status) => {
                try {
                    await database.ref(`reservations/${id}`).update({ paymentStatus: status });
                } catch (e) {
                    console.error('ÊîØÊâï„ÅÑÁä∂Ê≥ÅÊõ¥Êñ∞„Ç®„É©„Éº', e);
                    alert('Êõ¥Êñ∞„Å´Â§±Êïó„Åó„Åæ„Åó„Åü');
                }
            }, []);

            // Settings Save Handler
            const handleSaveSettings = useCallback(async () => {
                if (!isAdmin) return;
                try {
                    await database.ref('settings/prices').set(priceSettings);
                    alert('ÊñôÈáëË®≠ÂÆö„Çí‰øùÂ≠ò„Åó„Åæ„Åó„Åü');
                } catch (e) {
                    console.error('Ë®≠ÂÆö‰øùÂ≠ò„Ç®„É©„Éº', e);
                    alert('Ë®≠ÂÆö„ÅÆ‰øùÂ≠ò„Å´Â§±Êïó„Åó„Åæ„Åó„Åü');
                }
            }, [isAdmin, priceSettings]);

            const handleSettingChange = useCallback((index, field, value) => {
                setPriceSettings(prev => {
                    const newRates = [...prev.rates];
                    newRates[index][field] = Number(value);
                    return { ...prev, rates: newRates };
                });
            }, []);

            const handleAddMember = useCallback(async (e) => {
                e.preventDefault();
                if (!newMemberName || !newMemberPin) return alert('ÂÖ•Âäõ„Åå‰∏çË∂≥„Åó„Å¶„ÅÑ„Åæ„Åô');
                if (!/^\d{4}$/.test(newMemberPin)) return alert('PIN„ÅØ4Ê°Å„ÅÆÊï∞Â≠ó„Åß');
                if (members.some(m => m.name === newMemberName)) return alert('ÂêåÂêç„ÅÆ„É°„É≥„Éê„Éº„ÅåÂ≠òÂú®„Åó„Åæ„Åô');
                try {
                    await database.ref('members').push({ name: newMemberName, pin: newMemberPin, isAdmin: newMemberIsAdmin });
                    setNewMemberName(''); setNewMemberPin(''); setNewMemberIsAdmin(false);
                    setShowAddMemberModal(false);
                    alert('„É°„É≥„Éê„Éº„ÇíËøΩÂä†„Åó„Åæ„Åó„Åü');
                } catch (e) { alert('ËøΩÂä†Â§±Êïó'); }
            }, [newMemberName, newMemberPin, newMemberIsAdmin, members]);

            const handleDeleteMember = useCallback(async (id, name) => {
                if (!isAdmin) return;
                const m = members.find(m => m.id === id);
                if (m && m.isAdmin) return alert('ÁÆ°ÁêÜËÄÖ„ÅØÂâäÈô§„Åß„Åç„Åæ„Åõ„Çì');
                if (reservations.some(r => r.member === name)) return alert('‰∫àÁ¥Ñ„Åå„ÅÇ„Çã„Åü„ÇÅÂâäÈô§„Åß„Åç„Åæ„Åõ„Çì');
                if (window.confirm(`${name}„ÇíÂâäÈô§„Åó„Åæ„Åô„ÅãÔºü`)) {
                    await database.ref(`members/${id}`).remove();
                }
            }, [isAdmin, members, reservations]);

            const handleToggleAdmin = useCallback(async (id, name, makeAdmin) => {
                if (!isAdmin) return;
                if (window.confirm(`${name}„ÅÆÊ®©Èôê„ÇíÂ§âÊõ¥„Åó„Åæ„Åô„ÅãÔºü`)) {
                    const m = members.find(m => m.id === id);
                    await database.ref(`members/${id}`).update({ ...m, isAdmin: makeAdmin });
                }
            }, [isAdmin, members]);

            const handleSubmit = useCallback(async (e) => {
                e.preventDefault();
                if (!formData.startDate || !formData.endDate || !calculatedPrice) return alert('Êó•ÊôÇ„ÇíÁ¢∫Ë™ç„Åó„Å¶„Åè„Å†„Åï„ÅÑ');
                if (!isFirebaseReady) return alert('FirebaseË®≠ÂÆö„ÅåÂøÖË¶Å„Åß„Åô');

                const startDateTime = `${formData.startDate} ${formData.startHour}:${formData.startMinute}`;
                const endDateTime = `${formData.endDate} ${formData.endHour}:${formData.endMinute}`;
                const newStart = new Date(`${formData.startDate}T${formData.startHour}:${formData.startMinute}:00`);
                const newEnd = new Date(`${formData.endDate}T${formData.endHour}:${formData.endMinute}:00`);

                const hasConflict = reservations.some(reservation => {
                    let rStart, rEnd;
                    if (reservation.startDateTime && reservation.endDateTime) {
                        rStart = new Date(reservation.startDateTime.replace(' ', 'T'));
                        rEnd = new Date(reservation.endDateTime.replace(' ', 'T'));
                    } else { 
                        rStart = new Date(`${reservation.date}T${reservation.startTime}:00`);
                        rEnd = new Date(`${reservation.date}T${reservation.endTime}:00`);
                    }
                    return newStart < rEnd && newEnd > rStart;
                });

                if (hasConflict) return alert('‰∫àÁ¥Ñ„ÅåÈáçË§á„Åó„Å¶„ÅÑ„Åæ„Åô');

                const newReservation = {
                    member: formData.member,
                    startDateTime, endDateTime, startDate: formData.startDate,
                    hours: calculatedHours, price: calculatedPrice,
                    createdAt: firebase.database.ServerValue.TIMESTAMP,
                    paymentStatus: 'unpaid'
                };

                try {
                    await database.ref('reservations').push(newReservation);
                    setFormData(prev => ({ ...prev, startDate: formData.startDate, endDate: formData.startDate }));
                    alert('‰∫àÁ¥Ñ„Åó„Åæ„Åó„Åü');
                } catch (e) { alert('‰∫àÁ¥ÑÂ§±Êïó'); }
            }, [formData, calculatedPrice, calculatedHours, reservations]);

            const handleDeleteReservation = useCallback(async (id) => {
                if (window.confirm('‰∫àÁ¥Ñ„ÇíÂâäÈô§„Åó„Åæ„Åô„ÅãÔºü')) await database.ref(`reservations/${id}`).remove();
            }, []);

            // useMemo„ÅßË®àÁÆóÁµêÊûú„Çí„Ç≠„É£„ÉÉ„Ç∑„É•
            const days = useMemo(() => {
                const year = currentDate.getFullYear(), month = currentDate.getMonth();
                const daysInMonth = new Date(year, month + 1, 0).getDate();
                const firstDay = new Date(year, month, 1).getDay();
                const prevLast = new Date(year, month, 0).getDate();
                const days = [];
                for (let i = firstDay - 1; i >= 0; i--) days.push({ date: new Date(year, month - 1, prevLast - i), isCurrentMonth: false });
                for (let i = 1; i <= daysInMonth; i++) days.push({ date: new Date(year, month, i), isCurrentMonth: true });
                const remaining = 42 - days.length;
                for (let i = 1; i <= remaining; i++) days.push({ date: new Date(year, month + 1, i), isCurrentMonth: false });
                return days;
            }, [currentDate]);

            const getReservationsForDate = useCallback((date) => {
                const dayStart = new Date(date); dayStart.setHours(0,0,0,0);
                const dayEnd = new Date(date); dayEnd.setHours(23,59,59,999);
                return reservations.filter(r => {
                    let s, e;
                    if (r.startDateTime) { s = new Date(r.startDateTime.replace(' ', 'T')); e = new Date(r.endDateTime.replace(' ', 'T')); }
                    else { s = new Date(`${r.date}T${r.startTime}:00`); e = new Date(`${r.date}T${r.endTime}:00`); }
                    return s < dayEnd && e > dayStart;
                });
            }, [reservations]);

            const getReservationsForMonth = useCallback((member, year, month) => {
                return reservations.filter(r => {
                    const d = new Date((r.startDate || r.date) + 'T00:00:00');
                    return (member === 'ALL' || r.member === member) && d.getFullYear() === year && d.getMonth() === month;
                }).sort((a, b) => new Date((a.startDate||a.date)+'T00:00:00') - new Date((b.startDate||b.date)+'T00:00:00'));
            }, [reservations]);

            const getMemberStatsForMonth = useCallback((year, month) => {
                const stats = {};
                let totalAllCount = 0, totalAllHours = 0, totalAllPrice = 0;

                reservations.forEach(r => {
                    const d = new Date((r.startDate || r.date) + 'T00:00:00');
                    if (d.getFullYear() === year && d.getMonth() === month) {
                        if (!stats[r.member]) stats[r.member] = { count: 0, totalHours: 0, totalPrice: 0 };
                        stats[r.member].count++;
                        stats[r.member].totalHours += r.hours;
                        stats[r.member].totalPrice += r.price;
                        
                        totalAllCount++;
                        totalAllHours += r.hours;
                        totalAllPrice += r.price;
                    }
                });
                return { stats, totalAllCount, totalAllHours, totalAllPrice };
            }, [reservations]);

            const renderStatusBadge = useCallback((status) => {
                if (status === 'confirmed') return <span className="payment-status status-paid">ÂèóÂèñÊ∏à</span>;
                if (status === 'pending') return <span className="payment-status status-pending">Á¢∫Ë™çÂæÖ„Å°</span>;
                return <span className="payment-status status-unpaid">Êú™Êâï„ÅÑ</span>;
            }, []);

            const notifications = useMemo(() => {
                const now = new Date();
                const isPast = (r) => {
                    let end;
                    if (r.endDateTime) end = new Date(r.endDateTime.replace(' ', 'T'));
                    else end = new Date(`${r.date}T${r.endTime}:00`);
                    return end < now;
                };

                if (isAdmin) {
                    return reservations.filter(r => r.paymentStatus === 'pending');
                } else {
                    return reservations.filter(r => r.member === currentUser && r.paymentStatus === 'unpaid' && isPast(r));
                }
            }, [isAdmin, reservations, currentUser]);

            if (isLoading) return <div className="container" style={{textAlign:'center', padding:'50px'}}>„Éá„Éº„Çø„ÇíË™≠„ÅøËæº„Åø‰∏≠...</div>;

            const sidebarDate = rangeStart || new Date();
            const selectedDateReservations = getReservationsForDate(sidebarDate);

            return (
                <>
                    {/* Login Modal */}
                    {showLoginModal && (
                        <div className="modal-overlay">
                            <div className="modal-content">
                                <h2>üîê „É≠„Ç∞„Ç§„É≥</h2>
                                <form onSubmit={handleLogin} className="login-form">
                                    <div className="form-group">
                                        <label>‰ΩøÁî®ËÄÖ„ÇíÈÅ∏Êäû</label>
                                        <select value={selectedMemberForLogin} onChange={(e) => setSelectedMemberForLogin(e.target.value)}>
                                            {members.map(m => <option key={m.id} value={m.name}>{m.name}</option>)}
                                        </select>
                                    </div>
                                    <input type="password" inputMode="numeric" pattern="[0-9]*" className="pin-input" value={pinInput} onChange={e => setPinInput(e.target.value)} maxLength="4" placeholder="‚Ä¢‚Ä¢‚Ä¢‚Ä¢" required autoFocus />
                                    <button type="submit" className="btn-primary">„É≠„Ç∞„Ç§„É≥</button>
                                </form>
                            </div>
                        </div>
                    )}

                    {/* Member List Modal */}
                    {showMemberListModal && (
                        <div className="modal-overlay">
                            <div className="modal-content" style={{maxWidth: '500px'}}>
                                <h2>üë• „É°„É≥„Éê„Éº‰∏ÄË¶ß</h2>
                                <div className="member-list">
                                    {members.map(m => (
                                        <div key={m.id} className="member-item">
                                            <div style={{flex: 1, overflow: 'hidden', textOverflow: 'ellipsis', whiteSpace: 'nowrap'}}>
                                                <span className="member-name">{m.name}</span> {m.isAdmin && 'üëë'}
                                            </div>
                                            {isAdmin && (
                                                <div style={{display: 'flex', gap: '5px', flexWrap: 'wrap'}}>
                                                    {!m.isAdmin && <button className="list-action-btn btn-promote" onClick={() => handleToggleAdmin(m.id, m.name, true)}>ÊòáÊ†º</button>}
                                                    {m.isAdmin && m.name !== currentUser && <button className="list-action-btn btn-demote" onClick={() => handleToggleAdmin(m.id, m.name, false)}>Ëß£Èô§</button>}
                                                    <button className="list-action-btn btn-delete" onClick={() => handleDeleteMember(m.id, m.name)}>ÂâäÈô§</button>
                                                </div>
                                            )}
                                        </div>
                                    ))}
                                </div>
                                <button className="btn-secondary" style={{marginTop:'auto'}} onClick={() => setShowMemberListModal(false)}>Èñâ„Åò„Çã</button>
                            </div>
                        </div>
                    )}

                    {/* Add Member Modal */}
                    {showAddMemberModal && (
                        <div className="modal-overlay">
                            <div className="modal-content" style={{maxWidth: '450px'}}>
                                <h2>‚ûï Êñ∞Ë¶è„É°„É≥„Éê„ÉºËøΩÂä†</h2>
                                <form onSubmit={handleAddMember} className="login-form">
                                    <div className="form-group"><label>ÂêçÂâç</label><input value={newMemberName} onChange={e => setNewMemberName(e.target.value)} required /></div>
                                    <div className="form-group"><label>PIN (4Ê°Å)</label><input type="password" inputMode="numeric" pattern="[0-9]*" className="pin-input" value={newMemberPin} onChange={e => setNewMemberPin(e.target.value)} maxLength="4" required /></div>
                                    
                                    {isAdmin && (
                                        <div className="form-group">
                                            <label className="checkbox-container">
                                                <input type="checkbox" className="checkbox-input" checked={newMemberIsAdmin} onChange={e => setNewMemberIsAdmin(e.target.checked)} />
                                                <span className="checkbox-text">üëë ÁÆ°ÁêÜËÄÖÊ®©Èôê„Çí‰ªò‰∏é„Åô„Çã</span>
                                            </label>
                                        </div>
                                    )}
                                    
                                    <div style={{display:'flex', gap:'10px'}}>
                                        <button type="submit" className="btn-primary" style={{flex: 1}}>ËøΩÂä†</button>
                                        <button type="button" className="btn-secondary" style={{flex: 1}} onClick={() => setShowAddMemberModal(false)}>„Ç≠„É£„É≥„Çª„É´</button>
                                    </div>
                                </form>
                            </div>
                        </div>
                    )}

                    {/* My History Modal */}
                    {showMyHistoryModal && (
                        <div className="modal-overlay">
                            <div className="modal-content" style={{maxWidth: '800px'}}>
                                <h2>üë§ „Éû„Ç§Â±•Ê≠¥: {currentUser}</h2>
                                <div className="month-selector">
                                    <button onClick={() => setMyHistoryMonth(new Date(myHistoryMonth.getFullYear(), myHistoryMonth.getMonth() - 1, 1))}>‚Üê</button>
                                    <span style={{fontSize: '1.2rem', fontWeight: '600', minWidth: '150px', textAlign: 'center'}}>{myHistoryMonth.getFullYear()}Âπ¥ {myHistoryMonth.getMonth() + 1}Êúà</span>
                                    <button onClick={() => setMyHistoryMonth(new Date(myHistoryMonth.getFullYear(), myHistoryMonth.getMonth() + 1, 1))}>‚Üí</button>
                                </div>
                                
                                <div className="reservation-list" style={{maxHeight:'50vh', marginBottom:'20px'}}>
                                    {getReservationsForMonth(currentUser, myHistoryMonth.getFullYear(), myHistoryMonth.getMonth()).map(r => (
                                        <div key={r.id} className="reservation-item">
                                            <h4>{r.startDate || r.date}</h4>
                                            <div className="reservation-detail">
                                                {r.startDateTime ? `${r.startDateTime} - ${r.endDateTime}` : `${r.startTime} - ${r.endTime}`}
                                            </div>
                                            <div className="reservation-price">
                                                <span>¬•{r.price.toLocaleString()} ({r.hours.toFixed(1)}h)</span>
                                                <div>
                                                    {renderStatusBadge(r.paymentStatus)}
                                                    {r.paymentStatus === 'unpaid' && (
                                                        <button className="pay-btn" onClick={() => {
                                                            const nextStatus = isAdmin ? 'confirmed' : 'pending';
                                                            const confirmMsg = isAdmin ? 'ÊîØÊâï„ÅÑ„ÇíË®òÈå≤„Åó„ÄÅÂèóÂèñÊ∏à„Åø„Å´„Åó„Åæ„Åô„ÅãÔºü' : 'ÊîØÊâï„ÅÑÂÆå‰∫Ü„ÇíÁÆ°ÁêÜËÄÖ„Å´ÈÄöÁü•„Åó„Åæ„Åô„ÅãÔºü';
                                                            if(window.confirm(confirmMsg)) updatePaymentStatus(r.id, nextStatus);
                                                        }}>ÊîØÊâï„ÅÑÂÆå‰∫Ü</button>
                                                    )}
                                                </div>
                                            </div>
                                        </div>
                                    ))}
                                    {getReservationsForMonth(currentUser, myHistoryMonth.getFullYear(), myHistoryMonth.getMonth()).length === 0 && <p style={{textAlign:'center', padding:'20px'}}>‰∫àÁ¥ÑÂ±•Ê≠¥„Åå„ÅÇ„Çä„Åæ„Åõ„Çì</p>}
                                </div>
                                <button className="btn-secondary" onClick={() => setShowMyHistoryModal(false)}>Èñâ„Åò„Çã</button>
                            </div>
                        </div>
                    )}

                    {/* Admin Mode Modal */}
                    {showAdminMode && isAdmin && (
                        <div className="modal-overlay">
                            <div className="modal-content" style={{maxWidth: '900px'}}>
                                <h2>üëë ÁÆ°ÁêÜËÄÖ„É¢„Éº„Éâ</h2>
                                
                                <div className="admin-tabs">
                                    <div className={`admin-tab ${adminTab === 'stats' ? 'active' : ''}`} onClick={() => setAdminTab('stats')}>üìä Áµ±Ë®à</div>
                                    <div className={`admin-tab ${adminTab === 'settings' ? 'active' : ''}`} onClick={() => setAdminTab('settings')}>‚öôÔ∏è ÊñôÈáëË®≠ÂÆö</div>
                                </div>

                                {adminTab === 'stats' ? (
                                    <>
                                        <div className="month-selector">
                                            <button onClick={() => setSelectedMonth(new Date(selectedMonth.getFullYear(), selectedMonth.getMonth() - 1, 1))}>‚Üê</button>
                                            <span style={{fontSize: '1.2rem', fontWeight: '600', minWidth: '150px', textAlign: 'center'}}>{selectedMonth.getFullYear()}Âπ¥ {selectedMonth.getMonth() + 1}Êúà</span>
                                            <button onClick={() => setSelectedMonth(new Date(selectedMonth.getFullYear(), selectedMonth.getMonth() + 1, 1))}>‚Üí</button>
                                        </div>

                                        <div style={{flex: 1, overflowY: 'auto', minHeight: '0'}}>
                                            {(() => {
                                                const { stats, totalAllCount, totalAllHours, totalAllPrice } = getMemberStatsForMonth(selectedMonth.getFullYear(), selectedMonth.getMonth());
                                                const memberNames = Object.keys(stats).sort();
                                                return (
                                                    <>
                                                        <h3 style={{color: 'var(--primary)', marginTop: '20px'}}>üìä ÊúàÈñìÁµ±Ë®à</h3>
                                                        <table className="stats-table">
                                                            <thead><tr><th>„É°„É≥„Éê„Éº</th><th>ÂõûÊï∞</th><th>ÊôÇÈñì</th><th>ÈáëÈ°ç</th><th>Ë©≥Á¥∞</th></tr></thead>
                                                            <tbody>
                                                                {memberNames.map(name => (
                                                                    <tr key={name}>
                                                                        <td style={{fontWeight:'600'}}>{name}</td>
                                                                        <td>{stats[name].count}</td>
                                                                        <td>{stats[name].totalHours.toFixed(1)}h</td>
                                                                        <td>¬•{stats[name].totalPrice.toLocaleString()}</td>
                                                                        <td><button className="header-btn" style={{background:'var(--primary)', color:'white'}} onClick={() => setSelectedMemberForStats(name)}>Ë©≥Á¥∞</button></td>
                                                                    </tr>
                                                                ))}
                                                            </tbody>
                                                            <tfoot>
                                                                <tr>
                                                                    <td>ÂêàË®à</td>
                                                                    <td>{totalAllCount}Âõû</td>
                                                                    <td>{totalAllHours.toFixed(1)}h</td>
                                                                    <td>¬•{totalAllPrice.toLocaleString()}</td>
                                                                    <td>-</td>
                                                                </tr>
                                                            </tfoot>
                                                        </table>

                                                        {selectedMemberForStats && (
                                                            <div style={{marginTop:'30px', borderTop:'2px solid var(--border)', paddingTop:'20px'}}>
                                                                <h3 style={{color: 'var(--primary)'}}>üìù {selectedMemberForStats} „ÅÆË©≥Á¥∞</h3>
                                                                <div className="reservation-list" style={{maxHeight: '300px'}}>
                                                                    {getReservationsForMonth(selectedMemberForStats, selectedMonth.getFullYear(), selectedMonth.getMonth()).map(r => (
                                                                        <div key={r.id} className="reservation-item">
                                                                            <h4>{r.startDate || r.date}</h4>
                                                                            <div className="reservation-detail">
                                                                                {r.startDateTime ? `${r.startDateTime} - ${r.endDateTime}` : `${r.startTime} - ${r.endTime}`}
                                                                            </div>
                                                                            <div className="reservation-price">
                                                                                <span>¬•{r.price.toLocaleString()} ({r.hours.toFixed(1)}h)</span>
                                                                                <div>
                                                                                    {renderStatusBadge(r.paymentStatus)}
                                                                                    {r.paymentStatus === 'pending' && (
                                                                                        <button className="confirm-btn" onClick={() => {
                                                                                            if(window.confirm('ÊîØÊâï„ÅÑ„ÇíÂèó„ÅëÂèñ„ÇäÊ∏à„Åø„Å´„Åó„Åæ„Åô„ÅãÔºü')) updatePaymentStatus(r.id, 'confirmed');
                                                                                        }}>ÂèóÂèñÁ¢∫Ë™ç</button>
                                                                                    )}
                                                                                    {r.paymentStatus === 'unpaid' && (
                                                                                        <button className="confirm-btn" style={{background: 'var(--primary)'}} onClick={() => {
                                                                                            if(window.confirm('ÊîØÊâï„ÅÑ„ÇíÂÆå‰∫Ü„Å®„Åó„ÄÅÂèóÂèñÊ∏à„Åø„Å´„Åó„Åæ„Åô„ÅãÔºü')) updatePaymentStatus(r.id, 'confirmed');
                                                                                        }}>ÂèóÂèñÂÆå‰∫Ü</button>
                                                                                    )}
                                                                                    <button className="delete-btn" style={{marginLeft:'10px', marginTop:0}} onClick={() => handleDeleteReservation(r.id)}>ÂâäÈô§</button>
                                                                                </div>
                                                                            </div>
                                                                        </div>
                                                                    ))}
                                                                </div>
                                                                <button className="btn-secondary" style={{width: '100%'}} onClick={() => setSelectedMemberForStats('')}>Ë©≥Á¥∞„ÇíÈñâ„Åò„Çã</button>
                                                            </div>
                                                        )}
                                                    </>
                                                );
                                            })()}
                                        </div>
                                    </>
                                ) : (
                                    // Settings Tab
                                    <div style={{flex: 1, overflowY: 'auto'}}>
                                        <h3 style={{color: 'var(--primary)', marginBottom: '15px'}}>‚öôÔ∏è ÊñôÈáë„Éó„É©„É≥Ë®≠ÂÆö</h3>
                                        <div className="settings-list">
                                            {priceSettings.rates.map((rate, index) => (
                                                <div key={index} className="setting-item">
                                                    <span className="setting-label">{rate.hours}ÊôÇÈñì‰ª•ÂÜÖ</span>
                                                    <div className="setting-input-group">
                                                        <input 
                                                            type="number" 
                                                            className="setting-input" 
                                                            value={rate.price} 
                                                            onChange={(e) => handleSettingChange(index, 'price', e.target.value)}
                                                        />
                                                        <span>ÂÜÜ</span>
                                                    </div>
                                                </div>
                                            ))}
                                            <div className="setting-item" style={{borderTop: '2px solid var(--primary)', marginTop: '10px'}}>
                                                <span className="setting-label">‰ª•Èôç24ÊôÇÈñì„Åî„Å®„ÅÆËøΩÂä†ÊñôÈáë</span>
                                                <div className="setting-input-group">
                                                    <input 
                                                        type="number" 
                                                        className="setting-input" 
                                                        value={priceSettings.extraDayPrice} 
                                                        onChange={(e) => setPriceSettings({...priceSettings, extraDayPrice: Number(e.target.value)})}
                                                    />
                                                    <span>ÂÜÜ</span>
                                                </div>
                                            </div>
                                        </div>
                                        <button className="btn-primary" onClick={handleSaveSettings}>Ë®≠ÂÆö„Çí‰øùÂ≠ò</button>
                                    </div>
                                )}

                                <button className="btn-secondary" style={{marginTop:'20px', flexShrink: 0}} onClick={() => {setShowAdminMode(false); setSelectedMemberForStats('');}}>ÁÆ°ÁêÜËÄÖ„É¢„Éº„ÉâÁµÇ‰∫Ü</button>
                            </div>
                        </div>
                    )}

                    {/* Main Dashboard */}
                    <div className="container">
                        <div className="header">
                            <div className="header-left">
                                <h1><span className="car-icon">üöó</span>ÂÆ∂Êóè„Ç´„Éº„Ç∑„Çß„Ç¢ÁÆ°ÁêÜ</h1>
                            </div>
                            
                            <div style={{display: 'flex', flexDirection: 'column', alignItems: 'flex-end', gap: '10px', width: '100%'}}>
                                <div style={{display: 'flex', alignItems: 'center', flexWrap: 'wrap', justifyContent: 'flex-end', width: '100%'}}>
                                    
                                    {/* Notification Bell */}
                                    <div className="notification-container">
                                        <button className="notification-btn" onClick={() => setShowNotifications(!showNotifications)}>
                                            üîî
                                            {notifications.length > 0 && <span className="badge">{notifications.length}</span>}
                                        </button>
                                        
                                        {showNotifications && (
                                            <div className="notification-dropdown" ref={notificationRef}>
                                                <div className="notification-header">
                                                    {isAdmin ? 'üîî ÊâøË™çÂæÖ„Å°‰∏ÄË¶ß' : 'üîî Êú™Êâï„ÅÑ‰∏ÄË¶ß'}
                                                </div>
                                                {notifications.length === 0 ? (
                                                    <div style={{textAlign:'center', padding:'10px', color:'var(--text-light)'}}>
                                                        {isAdmin ? 'ÊâøË™çÂæÖ„Å°„ÅØ„ÅÇ„Çä„Åæ„Åõ„Çì' : 'Êú™Êâï„ÅÑ„ÅØ„ÅÇ„Çä„Åæ„Åõ„Çì'}
                                                    </div>
                                                ) : (
                                                    notifications.map(n => (
                                                        <div key={n.id} className="notification-item">
                                                            <div className="notif-title">{n.member} - {n.startDate || n.date}</div>
                                                            <div className="notif-desc">¬•{n.price.toLocaleString()} ({n.hours.toFixed(1)}h)</div>
                                                            <div className="notif-actions">
                                                                {isAdmin ? (
                                                                    <button className="confirm-btn" onClick={() => {
                                                                        if(window.confirm('ÂèóÂèñÁ¢∫Ë™ç„Åó„Åæ„Åô„ÅãÔºü')) updatePaymentStatus(n.id, 'confirmed');
                                                                    }}>ÂèóÂèñÁ¢∫Ë™ç</button>
                                                                ) : (
                                                                    <button className="pay-btn" onClick={() => {
                                                                        if(window.confirm('ÊîØÊâï„ÅÑÂÆå‰∫Ü„ÇíÈÄöÁü•„Åó„Åæ„Åô„ÅãÔºü')) updatePaymentStatus(n.id, 'pending');
                                                                    }}>ÊîØÊâï„ÅÑÂÆå‰∫Ü</button>
                                                                )}
                                                            </div>
                                                        </div>
                                                    ))
                                                )}
                                            </div>
                                        )}
                                    </div>

                                    <span style={{marginRight: '10px', fontWeight: '600'}}>„É≠„Ç∞„Ç§„É≥: <span style={{color:'var(--primary)'}}>{currentUser}</span></span>
                                    <button className="header-btn my-history-btn" onClick={() => setShowMyHistoryModal(true)}>üë§ „Éû„Ç§Â±•Ê≠¥</button>
                                    {isAdmin && <button className="header-btn admin-mode-btn" onClick={() => setShowAdminMode(true)}>üëë ÁÆ°ÁêÜËÄÖ</button>}
                                    <button className="header-btn manage-members-btn" onClick={() => setShowMemberListModal(true)}>üë• ‰∏ÄË¶ß</button>
                                    <button className="header-btn add-member-btn" onClick={() => setShowAddMemberModal(true)}>‚ûï ËøΩÂä†</button>
                                    <button className="header-btn logout-btn" onClick={handleLogout}>„É≠„Ç∞„Ç¢„Ç¶„Éà</button>
                                </div>
                                <div className="date-display">{new Date().toLocaleDateString('ja-JP', {year: 'numeric', month: 'long', day: 'numeric', weekday: 'long'})}</div>
                                <div style={{fontSize: '0.85rem', color: connectionStatus.includes('‚úÖ') ? '#27ae60' : '#e74c3c'}}>{connectionStatus}</div>
                            </div>
                        </div>

                        <div className="main-content">
                            <div className="calendar-section">
                                <div className="calendar-header">
                                    <h2>{currentDate.getFullYear()}Âπ¥ {currentDate.getMonth() + 1}Êúà</h2>
                                    <div className="nav-buttons">
                                        <button className="nav-btn" onClick={() => setCurrentDate(new Date(currentDate.getFullYear(), currentDate.getMonth() - 1))}>‚Üê</button>
                                        <button className="nav-btn" onClick={() => setCurrentDate(new Date(currentDate.getFullYear(), currentDate.getMonth() + 1))}>‚Üí</button>
                                    </div>
                                </div>
                                <div className="calendar">
                                    {['Êó•','Êúà','ÁÅ´','Ê∞¥','Êú®','Èáë','Âúü'].map((d, i) => <div key={i} className={`day-header ${i===0?'sunday':i===6?'saturday':''}`}>{d}</div>)}
                                    {days.map((d, i) => {
                                        const dateRes = getReservationsForDate(d.date);
                                        const isStart = rangeStart && d.date.getTime() === rangeStart.getTime();
                                        const isEnd = rangeEnd && d.date.getTime() === rangeEnd.getTime();
                                        const isInRange = rangeStart && rangeEnd && d.date > rangeStart && d.date < rangeEnd;
                                        const isToday = new Date().toDateString() === d.date.toDateString();
                                        let cls = `day-cell ${!d.isCurrentMonth?'other-month':''} ${isToday?'today':''} ${d.date.getDay()===0?'sunday':d.date.getDay()===6?'saturday':''}`;
                                        if (isStart) cls += ' range-start'; if (isEnd) cls += ' range-end'; if (isInRange) cls += ' in-range';
                                        
                                        return (
                                            <div key={i} className={cls} onClick={() => handleDateClick(d.date)}>
                                                <div className="day-number">{d.date.getDate()}</div>
                                                <div className="day-reservations">
                                                    {dateRes.slice(0, 3).map((r, idx) => <div key={idx} className="reservation-indicator" />)}
                                                </div>
                                            </div>
                                        );
                                    })}
                                </div>
                            </div>

                            <div className="sidebar">
                                <div className="card">
                                    <h3>üìÖ {sidebarDate.getMonth() + 1}/{sidebarDate.getDate()}„ÅÆ‰∫àÁ¥Ñ</h3>
                                    <div className="reservation-list" style={{maxHeight:'300px'}}>
                                        {selectedDateReservations.length === 0 ? <p style={{color:'gray', textAlign:'center'}}>‰∫àÁ¥Ñ„Å™„Åó</p> : 
                                            selectedDateReservations.map(r => (
                                                <div key={r.id} className="reservation-item">
                                                    <h4>{r.member}</h4>
                                                    <div className="reservation-detail">{r.startDateTime ? `${r.startDateTime.split(' ')[1]} - ${r.endDateTime.split(' ')[1]}` : `${r.startTime} - ${r.endTime}`}</div>
                                                    <div className="reservation-price">¬•{r.price.toLocaleString()}</div>
                                                    {(r.member === currentUser || isAdmin) && <button className="delete-btn" onClick={() => handleDeleteReservation(r.id)}>ÂâäÈô§</button>}
                                                </div>
                                            ))
                                        }
                                    </div>
                                </div>

                                <div className="card">
                                    <h3>‚ûï Êñ∞Ë¶è‰∫àÁ¥Ñ</h3>
                                    <form onSubmit={handleSubmit}>
                                        <div className="form-group">
                                            <label>‰ΩøÁî®ËÄÖ</label>
                                            <select value={formData.member} onChange={e => setFormData({...formData, member: e.target.value})}>
                                                {members.map(m => <option key={m.id} value={m.name}>{m.name}</option>)}
                                            </select>
                                        </div>
                                        <div className="form-group">
                                            <label>ÈñãÂßãÊó•ÊôÇ</label>
                                            <div style={{display: 'flex', gap: '10px', marginBottom: '10px'}}>
                                                <input type="date" value={formData.startDate} onChange={(e) => {
                                                    const newStartDate = e.target.value;
                                                    setFormData(prev => ({...prev, startDate: newStartDate, endDate: prev.endDate < newStartDate ? newStartDate : prev.endDate}));
                                                }} required style={{flex: 1}} />
                                            </div>
                                            <div style={{display:'flex', gap:'5px'}}>
                                                <select value={formData.startHour} onChange={e => setFormData({...formData, startHour: e.target.value})}>{Array.from({length:24},(_,i)=><option key={i} value={String(i).padStart(2,'0')}>{String(i).padStart(2,'0')}ÊôÇ</option>)}</select>
                                                <select value={formData.startMinute} onChange={e => setFormData({...formData, startMinute: e.target.value})}><option value="00">00ÂàÜ</option><option value="15">15ÂàÜ</option><option value="30">30ÂàÜ</option><option value="45">45ÂàÜ</option></select>
                                            </div>
                                        </div>
                                        <div className="form-group">
                                            <label>ÁµÇ‰∫ÜÊó•ÊôÇ</label>
                                            <div style={{display: 'flex', gap: '10px', marginBottom: '10px'}}>
                                                <input type="date" value={formData.endDate} onChange={(e) => setFormData({...formData, endDate: e.target.value})} min={formData.startDate} required style={{flex: 1}} />
                                            </div>
                                            <div style={{display:'flex', gap:'5px'}}>
                                                <select value={formData.endHour} onChange={e => setFormData({...formData, endHour: e.target.value})}>{Array.from({length:24},(_,i)=><option key={i} value={String(i).padStart(2,'0')}>{String(i).padStart(2,'0')}ÊôÇ</option>)}</select>
                                                <select value={formData.endMinute} onChange={e => setFormData({...formData, endMinute: e.target.value})}><option value="00">00ÂàÜ</option><option value="15">15ÂàÜ</option><option value="30">30ÂàÜ</option><option value="45">45ÂàÜ</option></select>
                                            </div>
                                        </div>
                                        {calculatedPrice && <div className="calculation-display"><p>ÊôÇÈñì: {calculatedHours.toFixed(2)}h</p><p>ÊñôÈáë: ¬•{calculatedPrice.toLocaleString()}</p></div>}
                                        <button type="submit" className="btn-primary">‰∫àÁ¥Ñ„Åô„Çã</button>
                                    </form>
                                </div>
                            </div>
                        </div>
                    </div>
                </>
            );
        };

        ReactDOM.render(<CarSharingApp />, document.getElementById('root'));
    </script>
</body>
</html>
